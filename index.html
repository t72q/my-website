<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>برا السالفة.. بس ما أدري — لعبة حفلات</title>
  <style>
    :root{
      /* ألوان أزرق هادئ */
      --bg:#eaf2ff;          /* خلفية فاتحة جداً */
      --card:#ffffff;        /* بطاقات بيضاء */
      --ink:#0f1a2b;         /* نص غامق */
      --muted:#6b7a90;       /* نص باهت */
      --dark:#1b1f3a;

      --primary:#3b82f6;     /* أزرق للأزرار */
      --primary-ink:#ffffff; /* نص زر */
      --accent:#1f3a8a;      /* أزرق أغمق للتفاصيل */
      --shadow:0 8px 18px rgba(15,26,43,.12);

      --chip:#eef2ff;        /* شِبّات الأسماء */
      --chip-ink:#1b1f3a;
      --tile-border:#e5ecff;
      --tile-active:#e8f0ff;
      --highlight:#fde68a;   /* شارة صغيرة */
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial
    }
    .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

    header{
      display:flex;align-items:center;justify-content:space-between;padding:16px 18px
    }
    header .home{
      background:var(--primary);border:none;color:#fff;width:44px;height:44px;border-radius:999px;
      display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer
    }
    header .milk{font-weight:700;opacity:.8;color:var(--accent)}

    .container{flex:1;padding:14px}
    h1,h2,h3{margin:0 0 12px}
    h1{font-size:28px}
    h2{font-size:22px}
    p{color:var(--muted)}

    .title{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .title .logo{
      width:38px;height:38px;display:grid;place-items:center;border-radius:12px;background:var(--accent);
      color:#fff;font-weight:900;box-shadow:var(--shadow)
    }
    .subtitle{opacity:.9;font-size:12px;color:var(--muted)}

    .card{background:var(--card);color:var(--dark);border:0;border-radius:18px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}

    button{cursor:pointer;border:none}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:14px 24px;border-radius:16px;
      font-size:18px;font-weight:800;box-shadow:0 6px 0 rgba(0,0,0,.08);transition:transform .05s ease-in
    }
    .btn:active{transform:translateY(2px)}
    .btn-primary{background:var(--primary);color:var(--primary-ink)}
    .btn-secondary{background:#eef2ff;color:#1b1f3a}
    .btn-ghost{background:rgba(59,130,246,.12);color:#0f1a2b}

    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:2px solid transparent;outline:none;background:#fff;color:#111
    }
    input:focus,select:focus,textarea:focus{border-color:#bfdbfe}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    .list{display:flex;gap:8px;flex-wrap:wrap}

    .pill{
      padding:12px 16px;border-radius:999px;background:var(--chip);color:var(--chip-ink);
      font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)
    }
    .pill button{width:auto;padding:6px 10px;border-radius:10px;background:#bfdbfe;color:#0f1a2b}

    .hidden{display:none}
    .grid{display:grid;gap:10px}

    .hr{height:1px;background:#dde6ff;margin:14px 0}
    .footer{opacity:.95;font-size:12px;color:var(--muted)}
    .big{font-size:22px;color:#1b1f3a}
    .word-flash{font-weight:900;font-size:34px;letter-spacing:1px;color:#1f3a8a}

    .badge{display:inline-block;padding:6px 10px;border-radius:12px;background:var(--highlight);color:#402d00;font-weight:800}
    .score{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:#eef2ff;color:#1b1f3a}

    .bottom{display:flex;gap:10px;justify-content:center;margin-top:8px}

    .handoff-box{background:#fff;color:#111;border-radius:18px;padding:18px;box-shadow:var(--shadow)}

    /* شبكة خيارات التخمين: 8 عناصر (4 أعمدة) */
    .choices{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:12px}
    .choice{background:#fff;border:2px solid var(--tile-border);border-radius:14px;padding:12px;font-weight:800;cursor:pointer}
    .choice.selected{border-color:#3b82f6;background:#eff6ff}

    /* شاشة عرض الأسماء (الروليت) */
    .name-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:12px 0}
    .tile{background:#fff;border:2px solid var(--tile-border);border-radius:14px;padding:14px;text-align:center;font-weight:900}
    .tile.active{border-color:#3b82f6;background:var(--tile-active);transform:scale(1.03)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <button class="home" id="homeBtn" title="الصفحة الرئيسية" type="button">🏠</button>
      <div class="milk">450 🥛</div>
    </header>
    <div class="container">
      <div class="title">
        <div class="logo">🕵️</div>
        <div>
          <h1 style="color:#0f1a2b;letter-spacing:1px;">برا السالفة.. بس ما أدري!</h1>
          <div class="subtitle">جلسة واقعية باستخدام الجوال: نحدد من يسأل من — بدون أسئلة تلقائية</div>
        </div>
      </div>

      <!-- أسماء اللاعبين -->
      <div id="view-names" class="card">
        <h2>أسماء اللاعبين</h2>
        <div class="row" style="align-items:flex-end">
          <div class="col">
            <label>أضف اسم لاعب</label>
            <input id="nameInput" placeholder="مثال: طارق">
          </div>
          <div class="col" style="max-width:200px">
            <button id="addNameBtn" class="btn btn-ghost" type="button">➕ إضافة</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="namesList" class="list"></div>
        <div class="hr"></div>
        <div class="bottom">
          <button id="toCategory" class="btn btn-primary" type="button">التالي: اختيار التصنيف</button>
          <button id="clearNames" class="btn btn-secondary" type="button">مسح الأسماء</button>
        </div>
        <p class="footer">يجب إضافة 3 لاعبين على الأقل.</p>
      </div>

      <!-- اختيار التصنيف -->
      <div id="view-category" class="card hidden">
        <h2>اختر التصنيف وطريقة الكلمات</h2>
        <div class="row">
          <div class="col">
            <label>التصنيف</label>
            <select id="categorySelect"></select>
          </div>
          <div class="col">
            <label>عدد الأدوار الحوارية قبل العرض</label>
            <select id="turnCount">
              <option value="4">4</option>
              <option value="6" selected>6</option>
              <option value="8">8</option>
            </select>
          </div>
          <div class="col">
            <label>طريقة الاختيار</label>
            <select id="pairMode">
              <option value="random" selected>عشوائي</option>
              <option value="manual">اختيار يدوي</option>
            </select>
          </div>
        </div>
        <div id="manualPairs" class="row hidden">
          <div class="col">
            <label>الكلمة الأساسية (للأغلبية)</label>
            <input id="baseWord" placeholder="مثال: قهوة">
          </div>
          <div class="col">
            <label>كلمة المختلف (قريبة من الأساسية)</label>
            <input id="oddWord" placeholder="مثال: شاي">
          </div>
        </div>
        <div class="hr"></div>
        <div class="bottom">
          <button class="btn btn-secondary" id="backToNames" type="button">رجوع</button>
          <button id="startRound" class="btn btn-primary" type="button">ابدأ الجولة</button>
        </div>
      </div>

      <!-- تمرير الجهاز للكلمة -->
      <div id="view-reveal" class="card hidden">
        <h2>تمرير الجهاز لكل لاعب</h2>
        <div id="handoffBox" class="handoff-box">
          <div id="handoffText" class="big">—</div>
          <div class="hr"></div>
          <button id="revealBtn" class="btn btn-primary" style="width:100%" type="button">عرض الكلمة</button>
          <div id="wordShown" class="word-flash center hidden" style="margin-top:8px"></div>
          <div id="hint" class="footer center hidden">سيختفي خلال 3 ثواني — لا تدع أحدًا يرى الشاشة</div>
        </div>
        <div class="bottom">
          <button class="btn btn-secondary" id="revealBack" type="button">رجوع</button>
          <button class="btn btn-primary" id="revealNext" type="button">التالي</button>
          <button class="btn btn-secondary" id="toDialogue" disabled type="button">ابدأ الجولة الحوارية</button>
        </div>
      </div>

      <!-- أدوار الحوار (من يسأل من) -->
      <div id="view-dialogue" class="card hidden">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h2>أدوار الحوار <span class="badge" id="tProgress">0/0</span></h2>
          <div class="badge" id="currentCategory">تصنيف</div>
        </div>
        <div class="hr"></div>
        <div class="card" style="text-align:center">
          <div class="big" style="margin-bottom:6px">الدور الآن:</div>
          <div id="pairText" class="word-flash" style="margin:6px 0 10px">—</div>
          <div class="subtitle">(يتكلم <span id="askerName" class="badge"></span> ويوجّه سؤالًا لـ <span id="targetName" class="badge"></span>)</div>
        </div>
        <div class="bottom">
          <button id="nextPair" class="btn btn-primary" type="button">الدور التالي</button>
          <button class="btn btn-secondary" id="goReveal" type="button">عرض المختلف</button>
        </div>
        <p class="footer">التطبيق فقط يحدد من يسأل من — لا يطرح أسئلة.</p>
      </div>

      <!-- عرض النتائج (الروليت يوقف على المختلف) -->
      <div id="view-odd" class="card hidden">
        <h2>عرض النتائج 🎬</h2>
        <div class="handoff-box" style="text-align:center">
          <div class="big" style="margin-bottom:8px">استعراض الأسماء بالتتابع</div>
          <div id="oddGrid" class="name-grid"></div>
          <div class="hr"></div>
          <div id="oddCycle" class="word-flash">جاهزين؟</div>
          <div class="bottom">
            <button id="startOddShow" class="btn btn-primary" type="button">ابدأ العرض</button>
            <button id="oddNext" class="btn btn-primary hidden" type="button">التالي</button>
          </div>
          <p class="footer">سيتم المرور على كل الأسماء والتوقف على صاحب الكلمة المختلفة.</p>
        </div>
      </div>

      <!-- تخمين الكلمة (يظهر للمختلف فقط) -->
      <div id="view-guess" class="card hidden">
        <h2>تخمين الكلمة المشتركة 🎯</h2>
        <p class="subtitle">اختر ما تعتقد أنه الكلمة التي ظهرت لبقية اللاعبين</p>
        <div id="choices" class="choices"></div>
        <div class="bottom">
          <button id="confirmGuess" class="btn btn-primary" type="button" disabled>تأكيد الاختيار</button>
        </div>
      </div>

      <!-- النتيجة -->
      <div id="view-result" class="card hidden">
        <h2>النتيجة</h2>
        <div id="resultSummary" class="grid"></div>
        <div class="hr"></div>
        <div class="bottom">
          <button class="btn btn-ghost" id="newRoundSame" type="button">جولة جديدة (نفس اللاعبين)</button>
          <button id="newRoundReset" class="btn btn-primary" type="button">إعداد جديد</button>
        </div>
      </div>

      <!-- سكورد بسيط (اختياري) -->
      <div id="view-score" class="card hidden">
        <h2>النتائج المتراكمة</h2>
        <div id="scoreList" class="list" style="flex-direction:column"></div>
      </div>
    </div>
  </div>

  <script>
  const PACKS = {
    "حيوانات":[["أسد","نمر"],["ذئب","كلب"],["قطة","أرنب"],["حصان","حمار"],["فيل","فرس النهر"],["جمل","لاما"],["صقر","نسر"],["دلفين","حوت"],["تمساح","سحلية"],["غزال","مها"]],
    "أكلات ومشروبات":[["بيتزا","برجر"],["شاورما","فاهيتا"],["قهوة","شاي"],["عصير برتقال","عصير مانجو"],["كابتشينو","لاتيه"],["رز","مكرونة"],["كعك","دونات"],["ماء غازي","عصير غازي"],["فول","حمص"],["عسل","دبس"]],
    "أماكن ومدن":[["باريس","لندن"],["مكة","المدينة"],["طوكيو","سول"],["الرياض","جدة"],["الصحراء","الواحة"],["شاطئ","مسبح"],["جامعة","مدرسة"],["مستشفى","عيادة"],["برج","قلعة"],["حديقة","محمية"]],
    "أشياء يومية":[["جوال","تابلت"],["مكيف","مروحة"],["قلم","ماركر"],["كرسي","أريكة"],["ريموت","يد تحكم"],["سماعات","سبيكر"],["حاسوب محمول","حاسوب مكتبي"],["مصباح","شمعة"],["ساعة يد","سوار ذكي"],["دراجة","سكوتر"]]
  };

  /* تشابهات يدوية دقيقة — لإنتاج مشتتات من نفس البيئة */
  const SIMILAR = {
    /* حيوانات */
    "أسد":["نمر","فهد","وشق","ضبع","ذئب","بوما","يغور"],
    "نمر":["أسد","فهد","وشق","ضبع","يغور","بوما","وشق صحراوي"],
    "ذئب":["ثعلب","ابن آوى","كلب","ضبع","كويوتي"],
    "كلب":["ذئب","ثعلب","ابن آوى","كويوتي"],
    "قطة":["وشق","قط بري","فهد","نمر","بوما"],
    "أرنب":["سنجاب","هامستر","خنزير غيني","أرنب بري"],
    "حصان":["حمار","بغل","حمار وحشي","مهر"],
    "حمار":["حصان","بغل","حمار وحشي"],
    "فيل":["فرس النهر","وحيد القرن","جاموس"],
    "فرس النهر":["فيل","وحيد القرن","جاموس"],
    "جمل":["لاما","ألباكا","حمار"],
    "لاما":["ألباكا","جمل","حمار"],
    "صقر":["نسر","شاهين","عقاب"],
    "نسر":["عقاب","صقر","رخمة"],
    "دلفين":["حوت","خنزير البحر","فقمة"],
    "حوت":["دلفين","حوت قاتل","فقمة"],
    "تمساح":["سحلية","وَرل","أفعى"],
    "سحلية":["تمساح","وَرل","أفعى"],
    "غزال":["ظبي","ريم","مها"],
    "مها":["غزال","ظبي","ريم"],

    /* أكلات ومشروبات */
    "بيتزا":["برجر","ساندوتش","باستا","لازانيا","سباغيتي","تاكو","فاهيتا"],
    "برجر":["شاورما","فاهيتا","ساندوتش","تاكو","بيتزا"],
    "شاورما":["فاهيتا","كباب","برجر","تاكو"],
    "فاهيتا":["شاورما","تاكو","برجر","بوريتو"],
    "قهوة":["كابتشينو","لاتيه","إسبرسو","موكا","فلات وايت"],
    "شاي":["قهوة","شاي بالحليب","نعناع","كرك"],
    "عصير برتقال":["عصير مانجو","عصير تفاح","عصير أناناس","عصير خوخ"],
    "عصير مانجو":["عصير برتقال","عصير خوخ","سموذي","عصير أناناس"],
    "كابتشينو":["لاتيه","موكا","إسبرسو","فلات وايت"],
    "لاتيه":["كابتشينو","موكا","فلات وايت","إسبرسو"],
    "رز":["مكرونة","كبسة","برياني","مضغوط"],
    "مكرونة":["لازانيا","سباغيتي","رز","باستا"],
    "كعك":["دونات","كب كيك","مافن","كرواسون"],
    "دونات":["كعك","مافن","كرواسون","كب كيك"],
    "ماء غازي":["عصير غازي","صودا","مشروب غازي"],
    "عصير غازي":["ماء غازي","صودا","مشروب غازي"],
    "فول":["حمص","فاصوليا","عدس","فول بالطحينة"],
    "حمص":["فول","متبّل","بابا غنوج","فلافل"],
    "عسل":["دبس","مربى","قطر","تمر"],
    "دبس":["عسل","قطر","تمر","مربى"],

    /* أماكن ومدن */
    "باريس":["لندن","روما","مدريد","برلين"],
    "لندن":["باريس","برلين","مانشستر","مدريد"],
    "مكة":["المدينة","جدة","الطائف","منى"],
    "المدينة":["مكة","ينبع","بدر","العلا"],
    "طوكيو":["سول","أوساكا","كيوتو","يوكوهاما"],
    "سول":["طوكيو","بوسان","دايغو","إنشيون"],
    "الرياض":["جدة","الدمام","مكة","الخبر"],
    "جدة":["الرياض","مكة","الطائف","ينبع"],
    "الصحراء":["الواحة","كثبان","سفاري","غابة"],
    "الواحة":["الصحراء","نخيل","عين ماء","سراب"],
    "شاطئ":["مسبح","بحر","مرسى","كورنيش"],
    "مسبح":["شاطئ","سبا","جاكوزي","ساونا"],
    "جامعة":["مدرسة","معهد","كلية","سكن طلاب"],
    "مدرسة":["جامعة","روضة","معهد","فصل"],
    "مستشفى":["عيادة","إسعاف","مركز صحي","صيدلية"],
    "عيادة":["مستشفى","صيدلية","مركز صحي","أشعة"],
    "برج":["قلعة","ناطحة سحاب","مبنى","منارة"],
    "قلعة":["برج","حصن","سور","خندق"],
    "حديقة":["محمية","متنزه","غابة","سفاري"],
    "محمية":["حديقة","سفاري","متنزه","غابة"],

    /* أشياء يومية */
    "جوال":["تابلت","حاسوب محمول","سماعات","سبيكر"],
    "تابلت":["جوال","حاسوب محمول","قلم إلكتروني","قارئ إلكتروني"],
    "مكيف":["مروحة","مبرد هواء","مكيف صحراوي","شفاط"],
    "مروحة":["مكيف","شفاط","مبرد هواء","مروحة سقف"],
    "قلم":["ماركر","قلم رصاص","حبر","قلم تظليل"],
    "ماركر":["قلم","قلم سبورة","قلم تظليل","حبر"],
    "كرسي":["أريكة","كنبة","مقعد","فوتيه"],
    "أريكة":["كرسي","كنبة زاوية","فوتيه","شيزلونج"],
    "ريموت":["يد تحكم","لوحة مفاتيح لاسلكية","فأرة لاسلكية","سماعات"],
    "يد تحكم":["ريموت","ذراع بلايستيشن","ذراع إكس بوكس","جوي كون"],
    "سماعات":["سبيكر","سماعات أذن","سماعات رأس","ساوندبار"],
    "سبيكر":["سماعات","مكبر صوت","ساوندبار","سماعات بلوتوث"],
    "حاسوب محمول":["حاسوب مكتبي","تابلت","لوحة مفاتيح","ماوس"],
    "حاسوب مكتبي":["حاسوب محمول","شاشة","فأرة","لوحة مفاتيح"],
    "مصباح":["شمعة","لمبة","كشاف","فانوس"],
    "شمعة":["مصباح","فانوس","ولاعة","كشاف"],
    "ساعة يد":["سوار ذكي","ساعة ذكية","منبّه","عداد خطى"],
    "سوار ذكي":["ساعة يد","ساعة ذكية","عداد خطى","سماعة رياضية"],
    "دراجة":["سكوتر","لوح تزلج","دراجة كهربائية","سكوتر كهربائي"],
    "سكوتر":["دراجة","لوح تزلج","سكوتر كهربائي","دراجة كهربائية"]
  };

  // ===== الحالة العامة =====
  let state = {
    players: [],
    scores: {},
    category: null,
    pair: null,           // { base, odd }
    oddIndex: null,       // من المختلف
    asked: 0,
    maxTurns: 6,
    revealIdx: 0,
    revealed: {},
    turnAskers: [],
    displayOrder: [],
    guessOptions: [],
    selectedGuess: null,
    guessCorrect: null
  };

  // ===== أدوات =====
  const $ = sel => document.querySelector(sel);
  const el = (t,c,h) => {const e=document.createElement(t); if(c) e.className=c; if(h!==undefined) e.innerHTML=h; return e;};
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const choice = arr => arr[Math.floor(Math.random()*arr.length)];

  function saveScores(){ localStorage.setItem('bsb_scores', JSON.stringify(state.scores)); }
  function loadScores(){ const s=localStorage.getItem('bsb_scores'); if(s) state.scores = JSON.parse(s); }
  function renderScores(){
    const box=$('#scoreList'); if(!box) return; box.innerHTML='';
    Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,pts])=> box.appendChild(el('div','score',`<strong>${n}</strong><span>${pts} نقطة</span>`)) );
    $('#view-score').classList.toggle('hidden', !Object.keys(state.scores).length);
  }
  function setView(id){
    ['#view-names','#view-category','#view-reveal','#view-dialogue','#view-odd','#view-guess','#view-result'].forEach(s=>$(s).classList.add('hidden'));
    $(id).classList.remove('hidden');
  }

  // ===== الأسماء =====
  function renderNames(){
    const list=$('#namesList'); list.innerHTML='';
    state.players.forEach((n,i)=>{
      const pill=el('div','pill');
      pill.appendChild(el('span',null,n));
      const del=el('button',null,'حذف'); del.type='button';
      del.onclick=()=>{state.players.splice(i,1); renderNames();};
      pill.appendChild(del);
      list.appendChild(pill);
    });
  }
  $('#addNameBtn')?.addEventListener('click',()=>{
    const v=$('#nameInput').value.trim(); if(!v) return;
    if(state.players.includes(v)) return alert('الاسم مكرر');
    state.players.push(v); $('#nameInput').value=''; renderNames();
  });
  $('#clearNames')?.addEventListener('click',()=>{ state.players=[]; renderNames(); });
  $('#toCategory')?.addEventListener('click',()=>{
    if(state.players.length<3) return alert('أضف 3 لاعبين على الأقل');
    loadScores(); state.players.forEach(n=>{ if(!(n in state.scores)) state.scores[n]=0; });
    renderScores(); buildCategoryUI(); setView('#view-category');
  });

  function buildCategoryUI(){
    const sel=$('#categorySelect'); sel.innerHTML='';
    Object.keys(PACKS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o);});
  }
  $('#pairMode')?.addEventListener('change',e=> $('#manualPairs').classList.toggle('hidden', e.target.value!=='manual'));
  $('#backToNames')?.addEventListener('click',()=> setView('#view-names'));

  // ===== بدء الجولة =====
  $('#startRound')?.addEventListener('click',()=>{
    state.maxTurns = parseInt($('#turnCount').value,10);
    state.category = $('#categorySelect').value;
    let base, odd;
    if($('#pairMode').value==='manual'){
      base=$('#baseWord').value.trim(); odd=$('#oddWord').value.trim();
      if(!base||!odd) return alert('املأ الكلمتين');
    } else {
      const p=choice(PACKS[state.category]); [base,odd] = Math.random()<.5 ? p : [p[1],p[0]];
    }
    state.pair={base,odd};
    state.oddIndex=Math.floor(Math.random()*state.players.length); // عشوائي فعلياً
    state.asked=0; state.revealIdx=0; state.revealed={};
    state.turnAskers=shuffle([...state.players]);
    buildRevealSequential(); setView('#view-reveal');
  });

  // ===== تمرير الكلمة لكل لاعب =====
  function buildRevealSequential(){
    updateHandoffText(); $('#wordShown').classList.add('hidden'); $('#hint').classList.add('hidden');
  }
  function updateHandoffText(){
    const name=state.players[state.revealIdx];
    $('#handoffText').innerHTML=`📱 <strong>أعطوا الجهاز <span class="badge">${name}</span></strong>`;
    $('#revealBtn').disabled=false;
  }
  $('#revealBtn')?.addEventListener('click',()=>{
    const i=state.revealIdx;
    const word=(i===state.oddIndex)?state.pair.odd:state.pair.base;
    const w=$('#wordShown'); w.textContent=word; w.classList.remove('hidden');
    $('#hint').classList.remove('hidden'); $('#revealBtn').disabled=true; state.revealed[state.players[i]]=true;
    setTimeout(()=>{ w.classList.add('hidden'); $('#hint').classList.add('hidden'); }, 3000);
  });
  $('#revealNext')?.addEventListener('click',()=>{
    if(!state.revealed[state.players[state.revealIdx]]){ alert('اعرض الكلمة لهذا اللاعب أولاً'); return; }
    if(state.revealIdx < state.players.length-1){
      state.revealIdx++; updateHandoffText();
      $('#revealBtn').disabled = false; $('#wordShown').classList.add('hidden'); $('#hint').classList.add('hidden');
    } else {
      $('#toDialogue').disabled = false;
      $('#handoffText').innerHTML = '✅ تم عرض الكلمات للجميع — اضغط ابدأ الجولة الحوارية';
    }
  });
  $('#revealBack')?.addEventListener('click',()=> setView('#view-category'));
  $('#toDialogue')?.addEventListener('click',()=>{
    if($('#toDialogue').disabled){ alert('أكمل تمرير الكلمات للجميع أولاً'); return; }
    const unseen = state.players.filter(n=>!state.revealed[n]);
    if(unseen.length){ if(!confirm('بعض اللاعبين لم يشاهدوا كلمتهم. البدء على أي حال؟')) return; }
    $('#currentCategory').textContent = state.category;
    updatePairUI(); setView('#view-dialogue');
  });

  // ===== أدوار الحوار =====
  function pickPair(){
    const asker = state.turnAskers[state.asked % state.turnAskers.length];
    const others = state.players.filter(p=>p!==asker);
    const target = choice(others);
    return {asker,target};
  }
  function updatePairUI(){
    $('#tProgress').textContent=`${state.asked}/${state.maxTurns}`;
    const {asker,target}=pickPair();
    $('#askerName').textContent=asker; $('#targetName').textContent=target;
    $('#pairText').textContent=`${asker} يسأل ${target}`;
  }
  $('#nextPair')?.addEventListener('click',()=>{
    if(state.asked+1>=state.maxTurns) return alert('بلغت حد الأدوار. اضغط عرض المختلف.');
    state.asked++; if(Math.random()<0.35) state.turnAskers=shuffle(state.turnAskers);
    updatePairUI();
  });
  $('#goReveal')?.addEventListener('click',()=>{
    prepOddShow(); setView('#view-odd');
  });

  // ===== عرض المختلف (روليت) =====
  function prepOddShow(){
    const startBtn = document.getElementById('startOddShow');
    const nextBtn  = document.getElementById('oddNext');
    const slot     = document.getElementById('oddCycle');
    if(startBtn){ startBtn.classList.remove('hidden'); }
    if(nextBtn){ nextBtn.classList.add('hidden'); }
    if(slot){ slot.textContent = 'جاهزين؟'; }
    buildOddGrid();
  }
  function buildOddGrid(){
    state.displayOrder = shuffle(state.players.map((_,i)=>i)); // ترتيب عرض عشوائي
    const grid = document.getElementById('oddGrid'); if(!grid) return; grid.innerHTML='';
    state.displayOrder.forEach((pIdx)=>{
      const div = document.createElement('div');
      div.className = 'tile'; div.id = 'tile_'+pIdx; div.textContent = state.players[pIdx];
      grid.appendChild(div);
    });
  }
  function startOddShow(){
    const startBtn = document.getElementById('startOddShow');
    const nextBtn  = document.getElementById('oddNext');
    const slot     = document.getElementById('oddCycle');
    if(startBtn) startBtn.classList.add('hidden');

    const orderIdx = state.displayOrder || state.players.map((_,i)=>i);
    const names = orderIdx.map(i=>state.players[i]);
    const finalIdxInOrder = orderIdx.indexOf(state.oddIndex);
    const totalSpins = names.length * 2 + Math.floor(Math.random()*names.length);

    const tick = (step)=>{
      const prev = document.querySelector('.tile.active'); if(prev) prev.classList.remove('active');
      const idx = step % names.length; const realIdx = orderIdx[idx];
      const tile = document.getElementById('tile_'+realIdx); if(tile) tile.classList.add('active');
      if(slot) slot.textContent = names[idx];
      if(step < totalSpins){
        const nextDelay = step < names.length ? 120 : (step > totalSpins - names.length ? 220 : 160);
        setTimeout(()=> tick(step+1), nextDelay);
      } else {
        const hop = (cur)=>{
          const p = document.querySelector('.tile.active'); if(p) p.classList.remove('active');
          const real = orderIdx[cur];
          const t = document.getElementById('tile_'+real); if(t) t.classList.add('active');
          if(slot) slot.innerHTML = `🎯 <b>${names[cur]}</b>`;
          if(cur === finalIdxInOrder){ if(nextBtn) nextBtn.classList.remove('hidden'); }
          else setTimeout(()=> hop((cur+1)%names.length), 240);
        };
        hop(step % names.length);
      }
    };
    tick(0);
  }
  document.getElementById('startOddShow')?.addEventListener('click', startOddShow);
  document.getElementById('oddNext')?.addEventListener('click', ()=>{
    buildGuessOptions(); setView('#view-guess');
  });

  // ===== تخمين الكلمة (للمختلف) — 8 خيارات من نفس البيئة =====
  function buildGuessOptions(){
    const correct = state.pair.base;      // كلمة الأغلبية (الإجابة الصحيحة)
    const oddWord = state.pair.odd;       // كلمة المختلف (لا نظهرها أبداً)

    // حوض المشتتات من نفس البيئة (SIMILAR) أو نفس التصنيف (احتياطي)
    let pool = [];
    if (SIMILAR[correct] && SIMILAR[correct].length){
      pool = SIMILAR[correct].slice();
    } else {
      const pack = PACKS[state.category].flat();
      pool = [...new Set(pack)];
    }

    // نظّف: لا تكرارات ولا الكلمتين الأساسيتين
    const cleaned = [...new Set(pool)].filter(w => w !== correct && w !== oddWord);

    const TARGET_TOTAL = 8;                 // الإجمالي (صحيحة + مشتتات)
    const NEED_DISTRACTORS = TARGET_TOTAL - 1;

    let distractors = shuffle(cleaned).slice(0, NEED_DISTRACTORS);
    if (distractors.length < NEED_DISTRACTORS){
      const extraPool = PACKS[state.category]
        .flat()
        .filter(w => w !== correct && w !== oddWord && !distractors.includes(w));
      const toTake = Math.min(NEED_DISTRACTORS - distractors.length, extraPool.length);
      distractors = distractors.concat(shuffle(extraPool).slice(0, toTake));
    }

    state.guessOptions = shuffle([correct, ...distractors]);
    state.selectedGuess=null; state.guessCorrect=null;

    const box=$('#choices'); box.innerHTML='';
    state.guessOptions.forEach(w=>{
      const b=el('button','choice',w); b.type='button';
      b.onclick=()=>{
        state.selectedGuess=w;
        document.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected'); $('#confirmGuess').disabled=false;
      };
      box.appendChild(b);
    });
    $('#confirmGuess').disabled=true;
  }

  document.getElementById('confirmGuess')?.addEventListener('click',()=>{
    const isCorrect = state.selectedGuess===state.pair.base; state.guessCorrect=isCorrect;
    if(isCorrect){ const oddName=state.players[state.oddIndex]; state.scores[oddName]=(state.scores[oddName]||0)+2; }
    saveScores();
    finishAndShowResults();
  });

  // ===== النتيجة =====
  function finishAndShowResults(){ setView('#view-result'); showResult(); }
  function showResult(){
    const box=$('#resultSummary'); box.innerHTML='';
    const a=el('div','card',`
      <div class="big">انتهت الجولة ✅</div>
      <div class="subtitle">تم تحديد المختلف ثم أعطيناه فرصة التخمين بدون ما نفضح الكلمات 😉</div>
      <div class="hr"></div>
      <div>نتيجة التخمين: ${state.guessCorrect===true? '<span class="badge">صحيحة (+2)</span>' : state.guessCorrect===false? '<span class="badge">غير صحيحة</span>' : '<span class="badge">—</span>'}</div>
    `);
    const c=el('div','card');
    c.innerHTML=`<h3 style="margin-bottom:10px;color:#1b1f3a">الترتيب الحالي</h3>`;
    const rank=el('div','list'); rank.style.flexDirection='column';
    Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,s])=>
      rank.appendChild(el('div','score',`<strong>${n}</strong><span>${s} نقطة</span>`))
    );
    c.appendChild(rank);
    box.append(a); box.append(c);
  }

  // أزرار عامة
  document.getElementById('homeBtn')?.addEventListener('click',()=> setView('#view-names'));
  document.getElementById('newRoundSame')?.addEventListener('click',()=>{ buildCategoryUI(); setView('#view-category'); });
  document.getElementById('newRoundReset')?.addEventListener('click',()=>{ state.players=[]; renderNames(); setView('#view-names'); });

  // init
  (function init(){
    loadScores(); renderScores(); renderNames();
  })();
  </script>
</body>
</html>
