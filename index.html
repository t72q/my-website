<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©.. Ø¨Ø³ Ù…Ø§ Ø£Ø¯Ø±ÙŠ â€” Ù„Ø¹Ø¨Ø© Ø­ÙÙ„Ø§Øª</title>
  <style>
    :root{
      --bg:#7c93d8; --card:#f3f5ff; --ink:#ffffff; --dark:#1b1f3a; --muted:#b9c3ef;
      --primary:#f7a61a; --primary-ink:#ffffff; --accent:#a21c49; --shadow:0 8px 18px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial}
    .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
header .home{background:#c03b6a;border:none;color:#fff;width:44px;height:44px;border-radius:999px;display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer}
header .milk{font-weight:700;opacity:.9}

.container{flex:1;padding:14px}
h1,h2,h3{margin:0 0 12px} h1{font-size:28px} h2{font-size:22px} p{color:var(--muted)}

.title{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.title .logo{width:38px;height:38px;display:grid;place-items:center;border-radius:12px;background:#c03b6a;font-weight:900;box-shadow:var(--shadow)}
.subtitle{opacity:.9;font-size:12px;color:#3b437a}

.card{background:var(--card);color:var(--dark);border:0;border-radius:18px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}

button{cursor:pointer;border:none}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:14px 24px;border-radius:16px;font-size:18px;font-weight:800;box-shadow:0 6px 0 rgba(0,0,0,.18);transition:transform .05s ease-in}
.btn:active{transform:translateY(2px)}
.btn-primary{background:var(--primary);color:var(--primary-ink)}
.btn-secondary{background:#e8ecff;color:#1b1f3a}
.btn-ghost{background:rgba(255,255,255,.14);color:#fff}

input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:2px solid transparent;outline:none;background:#fff;color:#111}
input:focus,select:focus,textarea:focus{border-color:#ffe29a}

.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px}
.list{display:flex;gap:8px;flex-wrap:wrap}

.pill{padding:12px 16px;border-radius:999px;background:#e8ecff;color:#1b1f3a;font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
.pill button{width:auto;padding:6px 10px;border-radius:10px;background:#ffb84a;color:#222}

.hidden{display:none}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}

.hr{height:1px;background:#dde2ff;margin:14px 0}
.footer{opacity:.9;font-size:12px;color:#3b437a}
.big{font-size:22px;color:#1b1f3a}
.word-flash{font-weight:900;font-size:34px;letter-spacing:1px;color:#c03b6a}

.badge{display:inline-block;padding:6px 10px;border-radius:12px;background:#ffe29a;color:#402d00;font-weight:800}
.score{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:#e8ecff;color:#1b1f3a}

.bottom{display:flex;gap:10px;justify-content:center;margin-top:8px}

.handoff-box{background:#fff;color:#111;border-radius:18px;padding:18px;box-shadow:var(--shadow)}
.choices{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
.choice{background:#fff;border:2px solid #e6eaff;border-radius:14px;padding:12px;font-weight:800;cursor:pointer}
.choice.selected{border-color:#f7a61a;background:#fff7e6}
.candidates{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
.candidate{background:#fff;border:2px solid #e6eaff;border-radius:14px;padding:12px;font-weight:800;cursor:pointer}
.candidate.disabled{opacity:.5;pointer-events:none}
.candidate.selected{border-color:var(--primary);background:#fff7e6}
/* Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø´Ø¨ÙƒØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ */
.name-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:12px 0}
.tile{background:#fff;border:2px solid #e6eaff;border-radius:14px;padding:14px;text-align:center;font-weight:900}
.tile.active{border-color:#f7a61a;background:#fff7e6;transform:scale(1.03)}

  </style>
</head>
<body>
  <div class="app">
    <header>
      <button class="home" id="homeBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ </button>
      <div class="milk">450 ğŸ¥›</div>
    </header>
    <div class="container">
      <div class="title">
        <div class="logo">ğŸ•µï¸</div>
        <div>
          <h1 style="color:#ffcf5b;letter-spacing:1px;text-shadow:0 2px 0 rgba(0,0,0,.08)">Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©.. Ø¨Ø³ Ù…Ø§ Ø£Ø¯Ø±ÙŠ!</h1>
          <div class="subtitle">Ø¬Ù„Ø³Ø© ÙˆØ§Ù‚Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: Ù†Ø­Ø¯Ø¯ Ù…Ù† ÙŠØ³Ø£Ù„ Ù…Ù† â€” Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¦Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
        </div>
      </div><!-- STEP 1: NAMES -->
  <div id="view-names" class="card">
    <h2>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <label>Ø£Ø¶Ù Ø§Ø³Ù… Ù„Ø§Ø¹Ø¨</label>
        <input id="nameInput" placeholder="Ù…Ø«Ø§Ù„: Ø·Ø§Ø±Ù‚">
      </div>
      <div class="col" style="max-width:200px">
        <button id="addNameBtn" class="btn btn-ghost">â• Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="namesList" class="list"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button id="toCategory" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ</button>
      <button id="clearNames" class="btn btn-secondary">Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
    </div>
    <p class="footer">ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</p>
  </div>

  <!-- STEP 2: CATEGORY & PAIRING -->
  <div id="view-category" class="card hidden">
    <h2>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª</h2>
    <div class="row">
      <div class="col">
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
        <select id="categorySelect"></select>
      </div>
      <div class="col">
        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø­ÙˆØ§Ø±ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØª</label>
        <select id="turnCount">
          <option value="4">4</option>
          <option value="6" selected>6</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="col">
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</label>
        <select id="pairMode">
          <option value="random" selected>Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
          <option value="manual">Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ</option>
        </select>
      </div>
    </div>
    <div id="manualPairs" class="row hidden">
      <div class="col">
        <label>Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ù„Ø£ØºÙ„Ø¨ÙŠØ©)</label>
        <input id="baseWord" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù‡ÙˆØ©">
      </div>
      <div class="col">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„Ù (Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)</label>
        <input id="oddWord" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§ÙŠ">
      </div>
    </div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-secondary" id="backToNames">Ø±Ø¬ÙˆØ¹</button>
      <button id="startRound" class="btn btn-primary">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
    </div>
  </div>

  <!-- STEP 3: PRIVATE REVEAL (SEQUENTIAL) -->
  <div id="view-reveal" class="card hidden">
    <h2>ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨</h2>
    <div id="handoffBox" class="handoff-box">
      <div id="handoffText" class="big">â€”</div>
      <div class="hr"></div>
      <button id="revealBtn" class="btn btn-primary" style="width:100%">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø©</button>
      <div id="wordShown" class="word-flash center hidden" style="margin-top:8px"></div>
      <div id="hint" class="footer center hidden">Ø³ÙŠØ®ØªÙÙŠ Ø®Ù„Ø§Ù„ 3 Ø«ÙˆØ§Ù†Ù â€” Ù„Ø§ ØªØ¯Ø¹ Ø£Ø­Ø¯Ù‹Ø§ ÙŠØ±Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©</div>
    </div>
    <div class="bottom">
      <button class="btn btn-secondary" id="revealBack">Ø±Ø¬ÙˆØ¹</button>
      <button class="btn btn-primary" id="revealNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      <button class="btn btn-secondary" id="toDialogue" disabled>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­ÙˆØ§Ø±ÙŠØ©</button>
    </div>
  </div>

  <!-- DIALOGUE (NO QUESTIONS) -->
  <div id="view-dialogue" class="card hidden">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2>Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø­ÙˆØ§Ø± <span class="badge" id="tProgress">0/0</span></h2>
      <div class="badge" id="currentCategory">ØªØµÙ†ÙŠÙ</div>
    </div>
    <div class="hr"></div>
    <div class="card" style="text-align:center">
      <div class="big" style="margin-bottom:6px">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†:</div>
      <div id="pairText" class="word-flash" style="margin:6px 0 10px">â€”</div>
      <div class="subtitle">(ÙŠØªÙƒÙ„Ù… <span id="askerName" class="badge"></span> ÙˆÙŠÙˆØ¬Ù‘Ù‡ Ø³Ø¤Ø§Ù„Ù‹Ø§ Ù„Ù€ <span id="targetName" class="badge"></span>)</div>
    </div>
    <div class="bottom">
      <button id="nextPair" class="btn btn-primary">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ</button>
      <button class="btn btn-secondary" id="goVote">Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØµÙˆÙŠØª</button>
    </div>
    <p class="footer">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù† ÙŠØ·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø©. ÙÙ‚Ø· ÙŠØ­Ø¯Ø¯ Ù…Ù† ÙŠØ³Ø£Ù„ Ù…Ù† ÙÙŠ ÙƒÙ„ Ø¯ÙˆØ±.</p>
  </div>

  <!-- VOTE -->
  <div id="view-vote" class="card hidden">
    <h2>Ø§Ù„ØªØµÙˆÙŠØª (Ø³Ø±ÙŠ)</h2>
    <div class="handoff-box">
      <div id="votePassText" class="big">ğŸ“± Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ â€”</div>
      <div class="hr"></div>
      <div id="voteChoices" class="candidates"></div>
      <div class="bottom">
        <button class="btn btn-primary" id="voteConfirm" disabled>ØªØ£ÙƒÙŠØ¯ ØªØµÙˆÙŠØªÙŠ</button>
      </div>
    </div>
    <p class="footer">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ´ÙˆÙ Ø´Ø§Ø´Ø© ØºÙŠØ±Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª.</p>
  </div>

  <!-- ODD REVEAL (roulette style) -->
  <div id="view-odd" class="card hidden">
    <h2>Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ¬</h2>
    <div class="handoff-box" style="text-align:center">
      <div class="big" style="margin-bottom:8px">Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹</div>
      <div id="oddGrid" class="name-grid"></div>
      <div class="hr"></div>
      <div id="oddCycle" class="word-flash">Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ</div>
      <div class="bottom">
        <button id="startOddShow" class="btn btn-primary">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø±Ø¶</button>
        <button id="oddNext" class="btn btn-primary hidden">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
      <p class="footer">Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„ØªÙˆÙ‚Ù Ø¹Ù„Ù‰ ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©.</p>
    </div>
  </div>

  <!-- RESULT -->
  <div id="view-result" class="card hidden">
    <h2>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
    <div id="resultSummary" class="grid"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-ghost" id="newRoundSame">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)</button>
      <button id="newRoundReset" class="btn btn-primary">Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <!-- SCOREBOARD -->
  <div id="view-score" class="card hidden">
    <h2>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©</h2>
    <div id="scoreList" class="list" style="flex-direction:column"></div>
  </div>
</div>

  </div>  <script>
  const PACKS = {"Ø­ÙŠÙˆØ§Ù†Ø§Øª":[["Ø£Ø³Ø¯","Ù†Ù…Ø±"],["Ø°Ø¦Ø¨","ÙƒÙ„Ø¨"],["Ù‚Ø·Ø©","Ø£Ø±Ù†Ø¨"],["Ø­ØµØ§Ù†","Ø­Ù…Ø§Ø±"],["ÙÙŠÙ„","ÙØ±Ø³ Ø§Ù„Ù†Ù‡Ø±"],["Ø¬Ù…Ù„","Ù„Ø§Ù…Ø§"],["ØµÙ‚Ø±","Ù†Ø³Ø±"],["Ø¯Ù„ÙÙŠÙ†","Ø­ÙˆØª"],["ØªÙ…Ø³Ø§Ø­","Ø³Ø­Ù„ÙŠØ©"],["ØºØ²Ø§Ù„","Ù…Ù‡Ø§"]],"Ø£ÙƒÙ„Ø§Øª ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª":[["Ø¨ÙŠØªØ²Ø§","Ø¨Ø±Ø¬Ø±"],["Ø´Ø§ÙˆØ±Ù…Ø§","ÙØ§Ù‡ÙŠØªØ§"],["Ù‚Ù‡ÙˆØ©","Ø´Ø§ÙŠ"],["Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„","Ø¹ØµÙŠØ± Ù…Ø§Ù†Ø¬Ùˆ"],["ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ","Ù„Ø§ØªÙŠÙ‡"],["Ø±Ø²","Ù…ÙƒØ±ÙˆÙ†Ø©"],["ÙƒØ¹Ùƒ","Ø¯ÙˆÙ†Ø§Øª"],["Ù…Ø§Ø¡ ØºØ§Ø²ÙŠ","Ø¹ØµÙŠØ± ØºØ§Ø²ÙŠ"],["ÙÙˆÙ„","Ø­Ù…Øµ"],["Ø¹Ø³Ù„","Ø¯Ø¨Ø³"]],"Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¯Ù†":[["Ø¨Ø§Ø±ÙŠØ³","Ù„Ù†Ø¯Ù†"],["Ù…ÙƒØ©","Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"],["Ø·ÙˆÙƒÙŠÙˆ","Ø³ÙˆÙ„"],["Ø§Ù„Ø±ÙŠØ§Ø¶","Ø¬Ø¯Ø©"],["Ø§Ù„ØµØ­Ø±Ø§Ø¡","Ø§Ù„ÙˆØ§Ø­Ø©"],["Ø´Ø§Ø·Ø¦","Ù…Ø³Ø¨Ø­"],["Ø¬Ø§Ù…Ø¹Ø©","Ù…Ø¯Ø±Ø³Ø©"],["Ù…Ø³ØªØ´ÙÙ‰","Ø¹ÙŠØ§Ø¯Ø©"],["Ø¨Ø±Ø¬","Ù‚Ù„Ø¹Ø©"],["Ø­Ø¯ÙŠÙ‚Ø©","Ù…Ø­Ù…ÙŠØ©"]],"Ø£Ø´ÙŠØ§Ø¡ ÙŠÙˆÙ…ÙŠØ©":[["Ø¬ÙˆØ§Ù„","ØªØ§Ø¨Ù„Øª"],["Ù…ÙƒÙŠÙ","Ù…Ø±ÙˆØ­Ø©"],["Ù‚Ù„Ù…","Ù…Ø§Ø±ÙƒØ±"],["ÙƒØ±Ø³ÙŠ","Ø£Ø±ÙŠÙƒØ©"],["Ø±ÙŠÙ…ÙˆØª","ÙŠØ¯ ØªØ­ÙƒÙ…"],["Ø³Ù…Ø§Ø¹Ø§Øª","Ø³Ø¨ÙŠÙƒØ±"],["Ø­Ø§Ø³ÙˆØ¨ Ù…Ø­Ù…ÙˆÙ„","Ø­Ø§Ø³ÙˆØ¨ Ù…ÙƒØªØ¨ÙŠ"],["Ù…ØµØ¨Ø§Ø­","Ø´Ù…Ø¹Ø©"],["Ø³Ø§Ø¹Ø© ÙŠØ¯","Ø³ÙˆØ§Ø± Ø°ÙƒÙŠ"],["Ø¯Ø±Ø§Ø¬Ø©","Ø³ÙƒÙˆØªØ±"]]};

  // ===== State =====
  let state = {
    players: [],
    scores: {},
    category: null,
    pair: null,          // { base, odd }
    oddIndex: null,      // ØµØ§Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    asked: 0,
    maxTurns: 6,
    votes: {},
    revealIdx: 0,
    revealed: {},
    turnAskers: [],
    voteIdx: 0,
    secretIdx: 0,
    secretPhase: 0,
    guessOptions: [],
    selectedGuess: null,
    guessCorrect: null,
    revealOddPresentation: true // Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø¯ÙˆÙ‘Ø§Ø±Ø© ØªÙƒØ´Ù Ø§Ù„Ù…Ø®ØªÙ„Ù
  };

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const el = (t,c,h) => {const e=document.createElement(t); if(c) e.className=c; if(h!==undefined) e.innerHTML=h; return e;};
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const choice = arr => arr[Math.floor(Math.random()*arr.length)];

  function saveScores(){ localStorage.setItem('bsb_scores', JSON.stringify(state.scores)); }
  function loadScores(){ const s=localStorage.getItem('bsb_scores'); if(s) state.scores = JSON.parse(s); }
  function renderScores(){ const box=$('#scoreList'); if(!box) return; box.innerHTML=''; Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,pts])=> box.appendChild(el('div','score',`<strong>${n}</strong><span>${pts} Ù†Ù‚Ø·Ø©</span>`)) ); $('#view-score').classList.toggle('hidden', !Object.keys(state.scores).length); }
  function setView(id){ ['#view-names','#view-category','#view-reveal','#view-dialogue','#view-vote','#view-odd','#view-secret','#view-guess','#view-result'].forEach(s=>$(s).classList.add('hidden')); $(id).classList.remove('hidden'); }

  // ===== Names =====
  function renderNames(){ const list=$('#namesList'); list.innerHTML=''; state.players.forEach((n,i)=>{ const pill=el('div','pill'); pill.appendChild(el('span',null,n)); const del=el('button',null,'Ø­Ø°Ù'); del.onclick=()=>{state.players.splice(i,1); renderNames();}; pill.appendChild(del); list.appendChild(pill);}); }
  $('#addNameBtn')?.addEventListener('click',()=>{ const v=$('#nameInput').value.trim(); if(!v) return; if(state.players.includes(v)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙƒØ±Ø±'); state.players.push(v); $('#nameInput').value=''; renderNames(); });
  $('#clearNames')?.addEventListener('click',()=>{ state.players=[]; renderNames(); });
  $('#toCategory')?.addEventListener('click',()=>{ if(state.players.length<3) return alert('Ø£Ø¶Ù 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); loadScores(); state.players.forEach(n=>{ if(!(n in state.scores)) state.scores[n]=0; }); renderScores(); buildCategoryUI(); setView('#view-category'); });

  function buildCategoryUI(){ const sel=$('#categorySelect'); sel.innerHTML=''; Object.keys(PACKS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o);}); }
  $('#pairMode')?.addEventListener('change',e=> $('#manualPairs').classList.toggle('hidden', e.target.value!=='manual') );
  $('#backToNames')?.addEventListener('click',()=> setView('#view-names'));

  $('#startRound')?.addEventListener('click',()=>{
    state.maxTurns = parseInt($('#turnCount').value,10);
    state.category = $('#categorySelect').value;
    let base, odd;
    if($('#pairMode').value==='manual'){
      base=$('#baseWord').value.trim(); odd=$('#oddWord').value.trim(); if(!base||!odd) return alert('Ø§Ù…Ù„Ø£ Ø§Ù„ÙƒÙ„Ù…ØªÙŠÙ†');
    } else {
      const p=choice(PACKS[state.category]); [base,odd] = Math.random()<.5 ? p : [p[1],p[0]];
    }
    state.pair={base,odd}; state.oddIndex=Math.floor(Math.random()*state.players.length);
    state.asked=0; state.votes={}; state.revealIdx=0; state.revealed={}; state.turnAskers=shuffle([...state.players]);
    buildRevealSequential(); setView('#view-reveal');
  });

  // ===== Reveal =====
  function buildRevealSequential(){ updateHandoffText(); $('#wordShown').classList.add('hidden'); $('#hint').classList.add('hidden'); }
  function updateHandoffText(){ const name=state.players[state.revealIdx]; $('#handoffText').innerHTML=`ğŸ“± <strong>Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬Ù‡Ø§Ø² <span class="badge">${name}</span></strong>`; $('#revealBtn').disabled=false; }
  $('#revealBtn')?.addEventListener('click',()=>{ const i=state.revealIdx; const word=(i===state.oddIndex)?state.pair.odd:state.pair.base; const w=$('#wordShown'); w.textContent=word; w.classList.remove('hidden'); $('#hint').classList.remove('hidden'); $('#revealBtn').disabled=true; state.revealed[state.players[i]]=true; setTimeout(()=>{ w.classList.add('hidden'); $('#hint').classList.add('hidden'); },3000); });
  $('#revealNext')?.addEventListener('click',()=>{
    if(!state.revealed[state.players[state.revealIdx]]){ alert('Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    if(state.revealIdx < state.players.length-1){
      state.revealIdx++; updateHandoffText();
      $('#revealBtn').disabled = false; $('#wordShown').classList.add('hidden'); $('#hint').classList.add('hidden');
    } else {
      $('#toDialogue').disabled = false;
      $('#handoffText').innerHTML = 'âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ â€” Ø§Ø¶ØºØ· Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­ÙˆØ§Ø±ÙŠØ©';
    }
  });
  $('#revealBack')?.addEventListener('click',()=> setView('#view-category'));
  $('#toDialogue')?.addEventListener('click',()=>{
    if($('#toDialogue').disabled){ alert('Ø£ÙƒÙ…Ù„ ØªÙ…Ø±ÙŠØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    const unseen = state.players.filter(n=>!state.revealed[n]);
    if(unseen.length){ if(!confirm('Ø¨Ø¹Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù… ÙŠØ´Ø§Ù‡Ø¯ÙˆØ§ ÙƒÙ„Ù…ØªÙ‡Ù…. Ø§Ù„Ø¨Ø¯Ø¡ Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ')) return; }
    $('#currentCategory').textContent = state.category;
    updatePairUI();
    setView('#view-dialogue');
  });

  // ===== Dialogue (who asks whom) =====
  function pickPair(){ const asker = state.turnAskers[state.asked % state.turnAskers.length]; const others = state.players.filter(p=>p!==asker); const target = choice(others); return {asker,target}; }
  function updatePairUI(){ $('#tProgress').textContent=`${state.asked}/${state.maxTurns}`; const {asker,target}=pickPair(); $('#askerName').textContent=asker; $('#targetName').textContent=target; $('#pairText').textContent=`${asker} ÙŠØ³Ø£Ù„ ${target}`; }
  $('#nextPair')?.addEventListener('click',()=>{ if(state.asked+1>=state.maxTurns) return alert('Ø¨Ù„ØºØª Ø­Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±. Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ØªØµÙˆÙŠØª.'); state.asked++; if(Math.random()<0.35) state.turnAskers=shuffle(state.turnAskers); updatePairUI(); });
  $('#goVote')?.addEventListener('click',()=>{ prepOddShow(); setView('#view-odd'); }); });
  $('#backToDialogue')?.addEventListener('click',()=> setView('#view-dialogue'));

  // ===== Voting (sequential & private) =====
  function startVotingSequence(){ state.voteIdx=0; state.votes={}; setView('#view-vote'); renderVoteForCurrent(); }
  function renderVoteForCurrent(){
    const voter = state.players[state.voteIdx];
    $('#votePassText').innerHTML = `ğŸ“± <strong>Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ <span class="badge">${voter}</span></strong>`;
    const box = $('#voteChoices'); box.innerHTML=''; $('#voteConfirm').disabled=true;
    state.players.forEach((p,i)=>{
      const b = el('button','candidate',p);
      if(p===voter){ b.classList.add('disabled'); b.title='Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù†ÙØ³Ùƒ'; }
      else { b.onclick=()=>{ document.querySelectorAll('#voteChoices .candidate').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); state.votes[voter]=i; $('#voteConfirm').disabled=false; }; }
      box.appendChild(b);
    });
  }
  document.getElementById('voteConfirm')?.addEventListener('click',()=>{
    const voter = state.players[state.voteIdx];
    if(!(voter in state.votes)) return alert('Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§ Ù„Ù„ØªØµÙˆÙŠØª');
    if(state.voteIdx < state.players.length-1){ state.voteIdx++; renderVoteForCurrent(); }
    else { finalizeVotes(); }
  });

  function finalizeVotes(){
    const tally = new Array(state.players.length).fill(0);
    Object.values(state.votes).forEach(i=>{ if(Number.isInteger(i)) tally[i]++; });
    const most = Math.max(...tally);
    const suspects = tally.map((c,i)=>[c,i]).filter(([c])=>c===most).map(([,i])=>i);
    const caught = suspects.includes(state.oddIndex);

    const oddName = state.players[state.oddIndex];
    if(caught){ state.scores[oddName]+=0; } else { state.scores[oddName]+=3; }
    for(const [voter,idx] of Object.entries(state.votes)){
      if(idx===state.oddIndex && caught) state.scores[voter]+=1; else if(idx!==state.oddIndex) state.scores[voter]-=1;
    }
    saveScores();
    if(state.revealOddPresentation){
      setView('#view-odd');
      prepOddShow();
    } else {
      startSecretSequence();
    }
  }

  // ===== ODD reveal (roulette) =====
  function prepOddShow(){
    const startBtn = document.getElementById('startOddShow');
    const nextBtn  = document.getElementById('oddNext');
    const slot     = document.getElementById('oddCycle');
    if(startBtn){ startBtn.classList.remove('hidden'); }
    if(nextBtn){ nextBtn.classList.add('hidden'); }
    if(slot){ slot.textContent = 'Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ'; }
    buildOddGrid();
  }
  function buildOddGrid(){
    const grid = document.getElementById('oddGrid'); if(!grid) return; grid.innerHTML='';
    state.players.forEach((name,idx)=>{
      const div = document.createElement('div');
      div.className = 'tile'; div.id = 'tile_'+idx; div.textContent = name; grid.appendChild(div);
    });
  }
  function startOddShow(){
    const startBtn = document.getElementById('startOddShow');
    const nextBtn  = document.getElementById('oddNext');
    const slot     = document.getElementById('oddCycle');
    if(startBtn) startBtn.classList.add('hidden');

    // Ø­Ù„Ù‚Ø© ØªÙ…Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¹Ø¯Ø© Ø¯ÙˆØ±Ø§Øª Ø«Ù… ØªØªÙˆÙ‚Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®ØªÙ„Ù
    let i = 0; const names = [...state.players];
    const totalSpins = names.length * 2 + Math.floor(Math.random()*names.length); // Ø¯ÙˆØ±Ø§Ù†ÙŠÙ† ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§
    const finalIndex = state.oddIndex;

    const tick = (step, delay)=>{
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø³Ø§Ø¨Ù‚
      const prev = document.querySelector('.tile.active'); if(prev) prev.classList.remove('active');
      const idx = step % names.length; const tile = document.getElementById('tile_'+idx); if(tile) tile.classList.add('active');
      if(slot) slot.textContent = names[idx];
      if(step < totalSpins){
        // ØªØ³Ø±ÙŠØ¹ Ø¨Ø³ÙŠØ· Ø«Ù… ØªØ¨Ø·ÙŠØ¡ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆÙ‚Ù
        const nextDelay = step < names.length ? 120 : (step > totalSpins - names.length ? 220 : 160);
        setTimeout(()=> tick(step+1, nextDelay), nextDelay);
      } else {
        // Ø§Ù†ØªÙ‚Ø§Ù„ ØªØ¯Ø±ÙŠØ¬ÙŠ Ø­ØªÙ‰ Ù†ØµÙ„ Ù„Ù„Ù…Ø®ØªÙ„Ù
        const hop = (cur)=>{
          const p = document.querySelector('.tile.active'); if(p) p.classList.remove('active');
          const t = document.getElementById('tile_'+cur); if(t) t.classList.add('active');
          if(slot) slot.innerHTML = `ğŸ¯ <b>${names[cur]}</b>`;
          if(cur === finalIndex){ if(nextBtn) nextBtn.classList.remove('hidden'); }
          else setTimeout(()=> hop((cur+1)%names.length), 240);
        };
        hop(idx);
      }
    };
    // Ø§Ø¨Ø¯Ø£
    tick(0, 140);
  }
  document.getElementById('startOddShow')?.addEventListener('click', startOddShow);
  document.getElementById('oddNext')?.addEventListener('click', ()=>{ buildGuessOptions(); setView('#view-guess'); }); showResult(); }); showResult(); });

  // ===== Secret sequence (two-step per player) =====
  function startSecretSequence(){ state.secretIdx=0; state.secretPhase=0; setView('#view-secret'); renderSecret(); }
  function renderSecret(){ const name=state.players[state.secretIdx]; const pass=$('#secretPassText'); if(state.secretPhase===0){ pass.innerHTML=`ğŸ“± <strong>Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ <span class="badge">${name}</span></strong>`; $('#secretNext').textContent='Ø§Ù„ØªØ§Ù„ÙŠ'; }
    else { // private content
      if(state.secretIdx===state.oddIndex){ // show guess screen instead
        buildGuessOptions(); setView('#view-guess'); return; }
      pass.innerHTML=`ğŸ«£ <strong>${name}</strong> â€” Ù„ÙŠØ³ Ø¯ÙˆØ±Ùƒ. Ø§Ø¶ØºØ· Ø§Ù„ØªØ§Ù„ÙŠ Ø«Ù… Ù…Ø±Ù‘Ø± Ø§Ù„Ø¬ÙˆØ§Ù„`; $('#secretNext').textContent='Ø§Ù„ØªØ§Ù„ÙŠ'; }
  }
  $('#secretNext')?.addEventListener('click',()=>{ if(state.secretPhase===0){ state.secretPhase=1; renderSecret(); } else { // move to next player
      state.secretPhase=0; if(state.secretIdx < state.players.length-1){ state.secretIdx++; setView('#view-secret'); renderSecret(); } else { // done
        finishAndShowResults(); }
    } });

  // ===== Guess (only odd sees this) =====
  function buildGuessOptions(){
    // create 4 options: correct base + 3 distractors from same category (unique, not odd word)
    const correct=state.pair.base; const pack=PACKS[state.category].flat(); // flatten words
    const pool=[...new Set(pack.filter(w=>w!==correct && w!==state.pair.odd))];
    const distractors=shuffle(pool).slice(0,3);
    state.guessOptions=shuffle([correct,...distractors]); state.selectedGuess=null; state.guessCorrect=null;
    const box=$('#choices'); box.innerHTML='';
    state.guessOptions.forEach(w=>{ const b=el('button','choice',w); b.onclick=()=>{ state.selectedGuess=w; document.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); $('#confirmGuess').disabled=false; }; box.appendChild(b); });
    $('#confirmGuess').disabled=true;
  }

  $('#confirmGuess')?.addEventListener('click',()=>{
    const isCorrect = state.selectedGuess===state.pair.base; state.guessCorrect=isCorrect;
    if(isCorrect){ state.scores[state.players[state.oddIndex]] = (state.scores[state.players[state.oddIndex]]||0) + 2; }
    saveScores();
    // After guess, mimic two-step flow: show short result then continue secret cycle
    const msg = isCorrect? 'ğŸ‘ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! (+2)' : 'âŒ Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
    $('#choices').innerHTML = `<div class="big">${msg}</div>`;
    const btn=$('#confirmGuess'); btn.textContent='Ø§Ù„ØªØ§Ù„ÙŠ'; btn.disabled=false; btn.onclick=()=>{ // return to secret flow
      setView('#view-secret'); state.secretPhase=0; if(state.secretIdx < state.players.length-1){ state.secretIdx++; renderSecret(); } else { finishAndShowResults(); }
    };
  });

  function finishAndShowResults(){ setView('#view-result'); showResult(); }

  // ===== Result (Ù„Ø§ Ù†ÙƒØ´Ù Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªÙ„Ù) =====
  function showResult(){
    const box=$('#resultSummary'); box.innerHTML='';
    const a=el('div','card',`
      <div class="big">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø© âœ…</div>
      <div class="subtitle">Ù„Ù† Ù†ÙƒØ´Ù Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªÙ„Ù Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØºÙ…ÙˆØ¶ ğŸ˜‰</div>
      <div class="hr"></div>
      <div>Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ†: ${state.guessCorrect===true? '<span class="badge">ØªÙ…Øª (+2)</span>' : state.guessCorrect===false? '<span class="badge">Ù„Ù… ØªØªÙ…</span>' : '<span class="badge">â€”</span>'}</div>
    `);
    const c=el('div','card'); c.innerHTML=`<h3 style="margin-bottom:10px;color:#1b1f3a">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>`; const rank=el('div','list'); rank.style.flexDirection='column'; Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,s])=> rank.appendChild(el('div','score',`<strong>${n}</strong><span>${s} Ù†Ù‚Ø·Ø©</span>`)) ); c.appendChild(rank);
    box.append(a); box.append(c);
  }

  // New round buttons + header
  document.getElementById('homeBtn')?.addEventListener('click',()=> setView('#view-names'));
  $('#newRoundSame')?.addEventListener('click',()=>{ buildCategoryUI(); setView('#view-category'); });
  $('#newRoundReset')?.addEventListener('click',()=>{ state.players=[]; renderNames(); setView('#view-names'); });

  // init
  loadScores(); renderScores(); renderNames();
  </script></body>
</html>
