<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©.. Ø¨Ø³ Ù…Ø§ Ø£Ø¯Ø±ÙŠ â€” Ù„Ø¹Ø¨Ø© Ø­ÙÙ„Ø§Øª</title>
  <style>
    :root{
      /* Ù„ÙˆØ­Ø© Ø²Ø±Ù‚Ø§Ø¡ Ù‡Ø§Ø¯Ø¦Ø© */
      --bg:#aec6ff;
      --bg2:#95b6ff;
      --card:#f6f8ff;
      --ink:#1c2848;
      --muted:#5d6d9b;
      --primary:#5BA3F7;      /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
      --primary-ink:#ffffff;
      --accent:#2f64c8;
      --shadow:0 8px 18px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial}
    .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

    header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
    header .home{background:var(--accent);border:none;color:#fff;width:44px;height:44px;border-radius:999px;display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer}
    header .milk{font-weight:700;opacity:.9}

    .container{flex:1;padding:14px}

    h1,h2,h3{margin:0 0 12px}
    h1{font-size:28px}
    h2{font-size:22px}
    p{color:var(--muted)}

    .title{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .title .logo{width:38px;height:38px;display:grid;place-items:center;border-radius:12px;background:var(--primary);color:#fff;font-weight:900;box-shadow:var(--shadow)}
    .subtitle{opacity:.95;font-size:12px;color:#2d3a63}

    .card{background:var(--card);color:var(--ink);border:0;border-radius:18px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}

    button{cursor:pointer;border:none}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:14px 24px;border-radius:16px;font-size:18px;font-weight:800;box-shadow:0 6px 0 rgba(0,0,0,.12);transition:transform .05s ease-in}
    .btn:active{transform:translateY(2px)}
    .btn-primary{background:var(--primary);color:var(--primary-ink)}
    .btn-secondary{background:#e5ecff;color:#1c2848}
    .btn-ghost{background:rgba(255,255,255,.35);color:#1c2848}

    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:2px solid transparent;outline:none;background:#fff;color:#111}
    input:focus,select:focus,textarea:focus{border-color:#b9ceff}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 240px}
    .list{display:flex;gap:8px;flex-wrap:wrap}

    .pill{padding:12px 16px;border-radius:999px;background:#e9efff;color:#1c2848;font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
    .pill button{width:auto;padding:6px 10px;border-radius:10px;background:#d6e2ff;color:#1c2848}

    .hidden{display:none}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}

    .hr{height:1px;background:#d9e2ff;margin:14px 0}
    .footer{opacity:.9;font-size:12px;color:#3a4b7e}
    .big{font-size:22px}
    .word-flash{font-weight:900;font-size:34px;letter-spacing:1px;color:var(--accent)}

    .badge{display:inline-block;padding:6px 10px;border-radius:12px;background:#d6e2ff;color:#1c2848;font-weight:800}
    .score{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:#e9efff;color:#1c2848}

    .bottom{display:flex;gap:10px;justify-content:center;margin-top:8px}

    .handoff-box{background:#fff;color:#111;border-radius:18px;padding:18px;box-shadow:var(--shadow)}
    .choices{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
    .choice{background:#fff;border:2px solid #e6eaff;border-radius:14px;padding:12px;font-weight:800;cursor:pointer}
    .choice.selected{border-color:var(--primary);background:#eef4ff}

    .candidates{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
    .candidate{background:#fff;border:2px solid #e6eaff;border-radius:14px;padding:12px;font-weight:800;cursor:pointer}
    .candidate.disabled{opacity:.5;pointer-events:none}
    .candidate.selected{border-color:var(--primary);background:#eef4ff}

    /* ØµÙØ­Ø© Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¨Ø³ÙŠØ·Ø© */
    .role-page{display:grid;place-items:center;text-align:center;min-height:46vh}
    .role-text{font-size:22px;line-height:1.8;color:#1c2848}

    @media (max-width:480px){
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <button class="home" id="homeBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" type="button">ğŸ </button>
      <div class="milk">450 ğŸ¥›</div>
    </header>
    <div class="container">
      <div class="title">
        <div class="logo">ğŸ•µï¸</div>
        <div>
          <h1 style="color:#0b2a6f;letter-spacing:1px;text-shadow:0 2px 0 rgba(0,0,0,.05)">Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©.. Ø¨Ø³ Ù…Ø§ Ø£Ø¯Ø±ÙŠ!</h1>
          <div class="subtitle">Ø¬Ù„Ø³Ø© ÙˆØ§Ù‚Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: Ù†Ø­Ø¯Ø¯ Ù…Ù† ÙŠØ³Ø£Ù„ Ù…Ù† â€” Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø¦Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
        </div>
      </div>

      <!-- STEP 1: NAMES -->
      <div id="view-names" class="card">
        <h2>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
        <div class="row" style="align-items:flex-end">
          <div class="col">
            <label>Ø£Ø¶Ù Ø§Ø³Ù… Ù„Ø§Ø¹Ø¨</label>
            <input id="nameInput" placeholder="Ù…Ø«Ø§Ù„: Ø·Ø§Ø±Ù‚">
          </div>
          <div class="col" style="max-width:200px">
            <button id="addNameBtn" class="btn btn-ghost" type="button">â• Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="namesList" class="list"></div>
        <div class="hr"></div>
        <div class="bottom">
          <button id="toCategory" class="btn btn-primary" type="button">Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ</button>
          <button id="clearNames" class="btn btn-secondary" type="button">Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
        </div>
        <p class="footer">ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</p>
      </div>

      <!-- STEP 2: CATEGORY & PAIRING -->
      <div id="view-category" class="card hidden">
        <h2>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª</h2>
        <div class="row">
          <div class="col">
            <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
            <select id="categorySelect"></select>
          </div>
          <div class="col">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø­ÙˆØ§Ø±ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØª</label>
            <select id="turnCount">
              <option value="4">4</option>
              <option value="6" selected>6</option>
              <option value="8">8</option>
            </select>
          </div>
          <div class="col">
            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</label>
            <select id="pairMode">
              <option value="random" selected>Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
              <option value="manual">Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ</option>
            </select>
          </div>
        </div>
        <div id="manualPairs" class="row hidden">
          <div class="col">
            <label>Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ù„Ø£ØºÙ„Ø¨ÙŠØ©)</label>
            <input id="baseWord" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù‡ÙˆØ©">
          </div>
          <div class="col">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„Ù (Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)</label>
            <input id="oddWord" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§ÙŠ">
          </div>
        </div>
        <div class="hr"></div>
        <div class="bottom">
          <button class="btn btn-secondary" id="backToNames" type="button">Ø±Ø¬ÙˆØ¹</button>
          <button id="startRound" class="btn btn-primary" type="button">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        </div>
      </div>

      <!-- STEP 3: PRIVATE REVEAL (SEQUENTIAL) -->
      <div id="view-reveal" class="card hidden">
        <h2>ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨</h2>
        <div id="handoffBox" class="handoff-box">
          <div id="handoffText" class="big">â€”</div>
          <div class="hr"></div>
          <button id="revealBtn" class="btn btn-primary" style="width:100%" type="button">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø©</button>
          <div id="wordShown" class="word-flash center hidden" style="margin-top:8px"></div>
          <div id="hint" class="footer center hidden">Ø³ÙŠØ®ØªÙÙŠ Ø®Ù„Ø§Ù„ 3 Ø«ÙˆØ§Ù†Ù â€” Ù„Ø§ ØªØ¯Ø¹ Ø£Ø­Ø¯Ù‹Ø§ ÙŠØ±Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©</div>
        </div>
        <div class="bottom">
          <button class="btn btn-secondary" id="revealBack" type="button">Ø±Ø¬ÙˆØ¹</button>
          <button class="btn btn-secondary" id="toDialogue" type="button" disabled>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­ÙˆØ§Ø±ÙŠØ©</button>
        </div>
      </div>

      <!-- NEW: ROLE INFO (neutral text + next) -->
      <div id="view-roleinfo" class="card hidden role-page">
        <div>
          <h2 id="roleTitle" style="text-align:center">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯ÙˆØ±Ùƒ</h2>
          <p id="roleInfoText" class="role-text">â€”</p>
          <div class="bottom">
            <button id="roleInfoNext" class="btn btn-primary" style="width:100%" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>
        </div>
      </div>

      <!-- DIALOGUE (NO QUESTIONS) -->
      <div id="view-dialogue" class="card hidden">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h2>Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø­ÙˆØ§Ø± <span class="badge" id="tProgress">0/0</span></h2>
          <div class="badge" id="currentCategory">ØªØµÙ†ÙŠÙ</div>
        </div>
        <div class="hr"></div>
        <div class="card" style="text-align:center">
          <div class="big" style="margin-bottom:6px">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†:</div>
          <div id="pairText" class="word-flash" style="margin:6px 0 10px">â€”</div>
          <div class="subtitle">(ÙŠØªÙƒÙ„Ù… <span id="askerName" class="badge"></span> ÙˆÙŠÙˆØ¬Ù‘Ù‡ Ø³Ø¤Ø§Ù„Ù‹Ø§ Ù„Ù€ <span id="targetName" class="badge"></span>)</div>
        </div>
        <div class="bottom">
          <button id="nextPair" class="btn btn-primary" type="button">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button class="btn btn-secondary" id="goVote" type="button">Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØµÙˆÙŠØª</button>
        </div>
        <p class="footer">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§ ÙŠØ·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø©Ø› ÙÙ‚Ø· ÙŠØ­Ø¯Ø¯ Ù…Ù† ÙŠØ³Ø£Ù„ Ù…Ù† ÙÙŠ ÙƒÙ„ Ø¯ÙˆØ±.</p>
      </div>

      <!-- VOTE (sequential & private) -->
      <div id="view-vote" class="card hidden">
        <h2>Ø§Ù„ØªØµÙˆÙŠØª (Ø³Ø±ÙŠ)</h2>
        <div class="handoff-box">
          <div id="votePassText" class="big">ğŸ“± Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ â€”</div>
          <div class="hr"></div>
          <div id="voteChoices" class="candidates"></div>
          <div class="bottom">
            <button class="btn btn-primary" id="voteConfirm" disabled type="button">ØªØ£ÙƒÙŠØ¯ ØªØµÙˆÙŠØªÙŠ</button>
          </div>
        </div>
        <p class="footer">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ´ÙˆÙ Ø´Ø§Ø´Ø© ØºÙŠØ±Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙˆÙŠØª.</p>
      </div>

      <!-- SECRET PASS AFTER VOTE (generic for all) -->
      <div id="view-secret" class="card hidden">
        <h2>ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª âœ…</h2>
        <div class="handoff-box">
          <div id="secretPassText" class="big">ğŸ“± Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ â€”</div>
          <div class="hr"></div>
          <button id="secretNext" class="btn btn-primary" style="width:100%" type="button">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
        <p class="footer">Ù„Ù† ÙŠÙÙƒØ´Ù Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªÙ„Ù â€” Ø§ØªÙ‘Ø¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙÙ‚Ø·.</p>
      </div>

      <!-- GUESS SCREEN (only for the real odd; neutral text) -->
      <div id="view-guess" class="card hidden">
        <h2>ØªØ®Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ğŸ¯</h2>
        <p class="subtitle">Ø§Ø®ØªØ± Ù…Ø§ ØªØ¹ØªÙ‚Ø¯ Ø£Ù†Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙŠ Ø¸Ù‡Ø±Øª Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</p>
        <div id="choices" class="choices"></div>
        <div class="bottom">
          <button id="confirmGuess" class="btn btn-primary" disabled style="width:100%" type="button">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</button>
        </div>
      </div>

      <!-- RESULT -->
      <div id="view-result" class="card hidden">
        <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø© âœ…</h2>
        <div id="resultSummary" class="grid"></div>
        <div class="hr"></div>
        <div class="bottom">
          <button class="btn btn-ghost" id="newRoundSame" type="button">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)</button>
          <button id="newRoundReset" class="btn btn-primary" type="button">Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</button>
        </div>
      </div>

      <!-- SCOREBOARD -->
      <div id="view-score" class="card hidden">
        <h2>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©</h2>
        <div id="scoreList" class="list" style="flex-direction:column"></div>
      </div>
    </div>
  </div>

  <script>
  // Ø­Ø²Ù… ÙƒÙ„Ù…Ø§Øª Ø«Ù†Ø§Ø¦ÙŠØ© (Base/Odd) â€” Ù…Ø¹ ØªØµÙ†ÙŠÙ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  const PACKS = {
    "Ø­ÙŠÙˆØ§Ù†Ø§Øª":[["Ø£Ø³Ø¯","Ù†Ù…Ø±"],["Ø°Ø¦Ø¨","ÙƒÙ„Ø¨"],["Ù‚Ø·Ø©","Ø£Ø±Ù†Ø¨"],["Ø­ØµØ§Ù†","Ø­Ù…Ø§Ø±"],["ÙÙŠÙ„","ÙØ±Ø³ Ø§Ù„Ù†Ù‡Ø±"],["Ø¬Ù…Ù„","Ù„Ø§Ù…Ø§"],["ØµÙ‚Ø±","Ù†Ø³Ø±"],["Ø¯Ù„ÙÙŠÙ†","Ø­ÙˆØª"],["ØªÙ…Ø³Ø§Ø­","Ø³Ø­Ù„ÙŠØ©"],["ØºØ²Ø§Ù„","Ù…Ù‡Ø§"]],
    "Ø£ÙƒÙ„Ø§Øª ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª":[["Ø¨ÙŠØªØ²Ø§","Ø¨Ø±Ø¬Ø±"],["Ø´Ø§ÙˆØ±Ù…Ø§","ÙØ§Ù‡ÙŠØªØ§"],["Ù‚Ù‡ÙˆØ©","Ø´Ø§ÙŠ"],["Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„","Ø¹ØµÙŠØ± Ù…Ø§Ù†Ø¬Ùˆ"],["ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ","Ù„Ø§ØªÙŠÙ‡"],["Ø±Ø²","Ù…ÙƒØ±ÙˆÙ†Ø©"],["ÙƒØ¹Ùƒ","Ø¯ÙˆÙ†Ø§Øª"],["Ù…Ø§Ø¡ ØºØ§Ø²ÙŠ","Ø¹ØµÙŠØ± ØºØ§Ø²ÙŠ"],["ÙÙˆÙ„","Ø­Ù…Øµ"],["Ø¹Ø³Ù„","Ø¯Ø¨Ø³"]],
    "Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¯Ù†":[["Ø¨Ø§Ø±ÙŠØ³","Ù„Ù†Ø¯Ù†"],["Ù…ÙƒØ©","Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"],["Ø·ÙˆÙƒÙŠÙˆ","Ø³ÙˆÙ„"],["Ø§Ù„Ø±ÙŠØ§Ø¶","Ø¬Ø¯Ø©"],["Ø§Ù„ØµØ­Ø±Ø§Ø¡","Ø§Ù„ÙˆØ§Ø­Ø©"],["Ø´Ø§Ø·Ø¦","Ù…Ø³Ø¨Ø­"],["Ø¬Ø§Ù…Ø¹Ø©","Ù…Ø¯Ø±Ø³Ø©"],["Ù…Ø³ØªØ´ÙÙ‰","Ø¹ÙŠØ§Ø¯Ø©"],["Ø¨Ø±Ø¬","Ù‚Ù„Ø¹Ø©"],["Ø­Ø¯ÙŠÙ‚Ø©","Ù…Ø­Ù…ÙŠØ©"]],
    "Ø£Ø´ÙŠØ§Ø¡ ÙŠÙˆÙ…ÙŠØ©":[["Ø¬ÙˆØ§Ù„","ØªØ§Ø¨Ù„Øª"],["Ù…ÙƒÙŠÙ","Ù…Ø±ÙˆØ­Ø©"],["Ù‚Ù„Ù…","Ù…Ø§Ø±ÙƒØ±"],["ÙƒØ±Ø³ÙŠ","Ø£Ø±ÙŠÙƒØ©"],["Ø±ÙŠÙ…ÙˆØª","ÙŠØ¯ ØªØ­ÙƒÙ…"],["Ø³Ù…Ø§Ø¹Ø§Øª","Ø³Ø¨ÙŠÙƒØ±"],["Ø­Ø§Ø³ÙˆØ¨ Ù…Ø­Ù…ÙˆÙ„","Ø­Ø§Ø³ÙˆØ¨ Ù…ÙƒØªØ¨ÙŠ"],["Ù…ØµØ¨Ø§Ø­","Ø´Ù…Ø¹Ø©"],["Ø³Ø§Ø¹Ø© ÙŠØ¯","Ø³ÙˆØ§Ø± Ø°ÙƒÙŠ"],["Ø¯Ø±Ø§Ø¬Ø©","Ø³ÙƒÙˆØªØ±"]]
  };

  // ===== Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© =====
  let state = {
    players: [],
    scores: {},
    category: null,
    pair: null,          // { base, odd }
    oddIndex: null,      // Ø±Ù‚Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    asked: 0,            // Ø¹Ø¯Ø§Ø¯ Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø­ÙˆØ§Ø±
    maxTurns: 6,
    votes: {},
    revealIdx: 0,
    revealed: {},
    turnAskers: [],
    // Ø§Ù„ØªØµÙˆÙŠØª Ø¨Ø§Ù„ØªÙ†Ø§ÙˆØ¨
    voteIdx: 0,
    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ©
    secretIdx: 0,
    secretPhase: 0,      // 0: Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙÙ„Ø§Ù† / 1: Ø´Ø§Ø´Ø© Ø®Ø§ØµØ© Ø£Ùˆ ØªØ®Ù…ÙŠÙ†
    guessOptions: [],
    selectedGuess: null,
    guessCorrect: null
  };

  // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =====
  const $ = sel => document.querySelector(sel);
  const el = (t,c,h) => {const e=document.createElement(t); if(c) e.className=c; if(h!==undefined) e.innerHTML=h; return e;};
  const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const choice  = arr => arr[Math.floor(Math.random()*arr.length)];

  function saveScores(){ localStorage.setItem('bsb_scores', JSON.stringify(state.scores)); }
  function loadScores(){ const s=localStorage.getItem('bsb_scores'); if(s) state.scores = JSON.parse(s); }
  function renderScores(){
    const box=$('#scoreList'); if(!box) return;
    box.innerHTML='';
    Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,pts])=>{
      box.appendChild(el('div','score',`<strong>${n}</strong><span>${pts} Ù†Ù‚Ø·Ø©</span>`));
    });
    $('#view-score').classList.toggle('hidden', !Object.keys(state.scores).length);
  }
  function setView(id){
    ['#view-names','#view-category','#view-reveal','#view-roleinfo','#view-dialogue','#view-vote','#view-secret','#view-guess','#view-result']
      .forEach(s=>$(s).classList.add('hidden'));
    $(id).classList.remove('hidden');
  }

  // ===== Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ =====
  function renderNames(){
    const list=$('#namesList'); list.innerHTML='';
    state.players.forEach((n,i)=>{
      const pill=el('div','pill');
      pill.appendChild(el('span',null,n));
      const del=el('button',null,'Ø­Ø°Ù'); del.type='button';
      del.onclick=()=>{state.players.splice(i,1); renderNames();};
      pill.appendChild(del); list.appendChild(pill);
    });
  }
  $('#addNameBtn')?.addEventListener('click',()=>{
    const v=$('#nameInput').value.trim(); if(!v) return;
    if(state.players.includes(v)) return alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙƒØ±Ø±');
    state.players.push(v); $('#nameInput').value=''; renderNames();
  });
  $('#clearNames')?.addEventListener('click',()=>{ state.players=[]; renderNames(); });
  $('#toCategory')?.addEventListener('click',()=>{
    if(state.players.length<3) return alert('Ø£Ø¶Ù 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    loadScores(); state.players.forEach(n=>{ if(!(n in state.scores)) state.scores[n]=0; });
    renderScores(); buildCategoryUI(); setView('#view-category');
  });

  function buildCategoryUI(){
    const sel=$('#categorySelect'); sel.innerHTML='';
    Object.keys(PACKS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o);});
  }
  $('#pairMode')?.addEventListener('change',e=> $('#manualPairs').classList.toggle('hidden', e.target.value!=='manual'));
  $('#backToNames')?.addEventListener('click',()=> setView('#view-names'));

  $('#startRound')?.addEventListener('click',()=>{
    state.maxTurns = parseInt($('#turnCount').value,10);
    state.category = $('#categorySelect').value;
    let base, odd;
    if($('#pairMode').value==='manual'){
      base=$('#baseWord').value.trim(); odd=$('#oddWord').value.trim();
      if(!base||!odd) return alert('Ø§Ù…Ù„Ø£ Ø§Ù„ÙƒÙ„Ù…ØªÙŠÙ†');
    } else {
      const p=choice(PACKS[state.category]); [base,odd] = Math.random()<.5 ? p : [p[1],p[0]];
    }
    state.pair={base,odd};
    state.oddIndex=Math.floor(Math.random()*state.players.length);
    state.asked=0; state.votes={}; state.revealIdx=0; state.revealed={};
    state.turnAskers=shuffle([...state.players]);
    buildRevealSequential(); setView('#view-reveal');
  });

  // ===== Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹ =====
  function buildRevealSequential(){
    updateHandoffText(); $('#wordShown').classList.add('hidden'); $('#hint').classList.add('hidden');
  }
  function updateHandoffText(){
    const name=state.players[state.revealIdx];
    $('#handoffText').innerHTML=`ğŸ“± <strong>Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬Ù‡Ø§Ø² <span class="badge">${name}</span></strong>`;
    $('#revealBtn').disabled=false;
  }
  $('#revealBtn')?.addEventListener('click',()=>{
    const i=state.revealIdx;
    const word=(i===state.oddIndex)?state.pair.odd:state.pair.base;
    const w=$('#wordShown');
    w.textContent=word; w.classList.remove('hidden');
    $('#hint').classList.remove('hidden');
    $('#revealBtn').disabled=true;
    state.revealed[state.players[i]]=true;
    setTimeout(()=>{
      w.classList.add('hidden'); $('#hint').classList.add('hidden');
      showRoleInfo(); // ØµÙØ­Ø© Ù†ØµÙŠØ© Ù…Ø­Ø§ÙŠØ¯Ø© + Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
    },2500);
  });

  // ØµÙØ­Ø© Ø¯ÙˆØ± Ù…Ø­Ø§ÙŠØ¯Ø© (Ø¨Ø¯ÙˆÙ† ÙƒØ´Ù)
  function showRoleInfo(){
    const name = state.players[state.revealIdx];
    $('#roleTitle').textContent = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯ÙˆØ±Ùƒ';
    $('#roleInfoText').innerHTML = `ÙŠØ§ <strong>${name}</strong>ØŒ ØªØ°ÙƒÙ‘Ø±: Ù„Ø§ ØªÙƒØ´Ù Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙŠ Ø¸Ù‡Ø±Øª Ù„Ùƒ. ØªÙƒÙ„Ù‘Ù… Ø¨Ø°ÙƒØ§Ø¡ ÙˆØ®Ù„Ùƒ ØºØ§Ù…Ø¶.`;
    setView('#view-roleinfo');
  }
  $('#roleInfoNext')?.addEventListener('click',()=>{
    if(state.revealIdx < state.players.length-1){
      state.revealIdx++; updateHandoffText(); setView('#view-reveal'); $('#revealBtn').disabled=false;
    } else {
      $('#toDialogue').disabled = false;
      $('#handoffText').innerHTML = 'âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­ÙˆØ§Ø±ÙŠØ©';
      setView('#view-reveal');
    }
  });

  $('#revealBack')?.addEventListener('click',()=> setView('#view-category'));
  $('#toDialogue')?.addEventListener('click',()=>{
    if($('#toDialogue').disabled){ alert('Ø£ÙƒÙ…Ù„ ØªÙ…Ø±ÙŠØ± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    $('#currentCategory').textContent=state.category;
    updatePairUI();
    setView('#view-dialogue');
  });

  // ===== Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø­ÙˆØ§Ø± (Ù…Ù† ÙŠØ³Ø£Ù„ Ù…Ù†) =====
  function pickPair(){
    const asker = state.turnAskers[state.asked % state.turnAskers.length];
    const others = state.players.filter(p=>p!==asker);
    const target = choice(others);
    return {asker,target};
  }
  function updatePairUI(){
    $('#tProgress').textContent=`${state.asked}/${state.maxTurns}`;
    const {asker,target}=pickPair();
    $('#askerName').textContent=asker;
    $('#targetName').textContent=target;
    $('#pairText').textContent=`${asker} ÙŠØ³Ø£Ù„ ${target}`;
  }
  $('#nextPair')?.addEventListener('click',()=>{
    if(state.asked+1>=state.maxTurns) return alert('Ø¨Ù„ØºØª Ø­Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±. Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ØªØµÙˆÙŠØª.');
    state.asked++; if(Math.random()<0.35) state.turnAskers=shuffle(state.turnAskers);
    updatePairUI();
  });
  $('#goVote')?.addEventListener('click',()=>{ startVotingSequence(); });
  $('#backToDialogue')?.addEventListener('click',()=> setView('#view-dialogue'));

  // ===== Ø§Ù„ØªØµÙˆÙŠØª â€” Ø³Ø±ÙŠ ÙˆØ¨Ø§Ù„ØªÙ…Ø±ÙŠØ± =====
  function startVotingSequence(){ state.voteIdx=0; state.votes={}; setView('#view-vote'); renderVoteForCurrent(); }
  function renderVoteForCurrent(){
    const voter = state.players[state.voteIdx];
    $('#votePassText').innerHTML = `ğŸ“± <strong>Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ <span class="badge">${voter}</span></strong>`;
    const box = $('#voteChoices'); box.innerHTML=''; $('#voteConfirm').disabled=true;
    state.players.forEach((p,i)=>{
      const b = el('button','candidate',p); b.type='button';
      if(p===voter){ b.classList.add('disabled'); b.title='Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù†ÙØ³Ùƒ'; }
      else {
        b.onclick=()=>{
          document.querySelectorAll('#voteChoices .candidate').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected'); state.votes[voter]=i; $('#voteConfirm').disabled=false;
        };
      }
      box.appendChild(b);
    });
  }
  document.getElementById('voteConfirm')?.addEventListener('click',()=>{
    const voter = state.players[state.voteIdx];
    if(!(voter in state.votes)) return alert('Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§ Ù„Ù„ØªØµÙˆÙŠØª');
    if(state.voteIdx < state.players.length-1){ state.voteIdx++; renderVoteForCurrent(); }
    else { finalizeVotes(); }
  });

  function finalizeVotes(){
    const tally = new Array(state.players.length).fill(0);
    Object.values(state.votes).forEach(i=>{ if(Number.isInteger(i)) tally[i]++; });
    const most = Math.max(...tally);
    const suspects = tally.map((c,i)=>[c,i]).filter(([c])=>c===most).map(([,i])=>i);
    const caught = suspects.includes(state.oddIndex);

    const oddName = state.players[state.oddIndex];
    if(caught){ state.scores[oddName]+=0; } else { state.scores[oddName]+=3; }
    for(const [voter,idx] of Object.entries(state.votes)){
      if(idx===state.oddIndex && caught) state.scores[voter]+=1; else if(idx!==state.oddIndex) state.scores[voter]-=1;
    }
    saveScores();
    startSecretSequence();
  }

  // ===== Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø±Ù‘ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙˆÙŠØª =====
  function startSecretSequence(){ state.secretIdx=0; state.secretPhase=0; setView('#view-secret'); renderSecret(); }
  function renderSecret(){
    const name=state.players[state.secretIdx];
    const pass=$('#secretPassText');
    if(state.secretPhase===0){
      pass.innerHTML=`ğŸ“± <strong>Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬ÙˆØ§Ù„ <span class="badge">${name}</span></strong>`;
      $('#secretNext').textContent='Ø§Ù„ØªØ§Ù„ÙŠ';
    } else {
      if(state.secretIdx===state.oddIndex){
        buildGuessOptions(); setView('#view-guess'); return;
      }
      pass.innerHTML=`ğŸ«£ Ø´Ø§Ø´Ø© Ø®Ø§ØµØ© â€” Ø§Ø¶ØºØ· Ø§Ù„ØªØ§Ù„ÙŠ Ø«Ù… Ù…Ø±Ù‘Ø± Ø§Ù„Ø¬ÙˆØ§Ù„`;
      $('#secretNext').textContent='Ø§Ù„ØªØ§Ù„ÙŠ';
    }
  }
  $('#secretNext')?.addEventListener('click',()=>{
    if(state.secretPhase===0){ state.secretPhase=1; renderSecret(); }
    else {
      state.secretPhase=0;
      if(state.secretIdx < state.players.length-1){
        state.secretIdx++; setView('#view-secret'); renderSecret();
      } else { finishAndShowResults(); }
    }
  });

  // ===== ØªØ®Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© (Ù…Ø­Ø§ÙŠØ¯) =====
  function buildGuessOptions(){
    const correct=state.pair.base;
    const pack=PACKS[state.category].flat();
    const pool=[...new Set(pack.filter(w=>w!==correct && w!==state.pair.odd))];
    const distractors=shuffle(pool).slice(0,3);
    state.guessOptions=shuffle([correct,...distractors]);
    state.selectedGuess=null; state.guessCorrect=null;

    const box=$('#choices'); box.innerHTML='';
    state.guessOptions.forEach(w=>{
      const b=el('button','choice',w); b.type='button';
      b.onclick=()=>{
        state.selectedGuess=w;
        document.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected'); $('#confirmGuess').disabled=false;
      };
      box.appendChild(b);
    });
    $('#confirmGuess').disabled=true;
  }
  $('#confirmGuess')?.addEventListener('click',()=>{
    const isCorrect=state.selectedGuess===state.pair.base; state.guessCorrect=isCorrect;
    if(isCorrect){ state.scores[state.players[state.oddIndex]]=(state.scores[state.players[state.oddIndex]]||0)+2; }
    saveScores();
    $('#choices').innerHTML = `<div class="big">${isCorrect? 'ğŸ‘ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! (+2)':'âŒ Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'}</div>`;
    const btn=$('#confirmGuess'); btn.textContent='Ø§Ù„ØªØ§Ù„ÙŠ'; btn.disabled=false;
    btn.onclick=()=>{
      setView('#view-secret'); state.secretPhase=0;
      if(state.secretIdx < state.players.length-1){ state.secretIdx++; renderSecret(); } else { finishAndShowResults(); }
    };
  });

  // ===== Ø§Ù„Ù†ØªÙŠØ¬Ø© =====
  function finishAndShowResults(){ setView('#view-result'); showResult(); }
  function showResult(){
    const box=$('#resultSummary'); box.innerHTML='';
    const a=el('div','card',`
      <div class="big">Ø§Ù„Ø¬ÙˆÙ„Ø© Ø®Ù„ØµØª â€” Ø³Ø±Ù‘ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø­ÙÙˆØ¸ ğŸ˜‰</div>
      <div class="hr"></div>
      <div>Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ†: ${state.guessCorrect===true? '<span class="badge">ØªÙ…Øª (+2)</span>' : state.guessCorrect===false? '<span class="badge">Ù„Ù… ØªØªÙ…</span>' : '<span class="badge">â€”</span>'}</div>
    `);
    const c=el('div','card');
    c.innerHTML=`<h3 style="margin-bottom:10px">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>`;
    const rank=el('div','list'); rank.style.flexDirection='column';
    Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,s])=>{
      rank.appendChild(el('div','score',`<strong>${n}</strong><span>${s} Ù†Ù‚Ø·Ø©</span>`));
    });
    c.appendChild(rank);
    box.append(a); box.append(c);
  }

  // Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø©
  document.getElementById('homeBtn')?.addEventListener('click',()=> setView('#view-names'));
  $('#newRoundSame')?.addEventListener('click',()=>{ buildCategoryUI(); setView('#view-category'); });
  $('#newRoundReset')?.addEventListener('click',()=>{ state.players=[]; renderNames(); setView('#view-names'); });

  // init
  loadScores(); renderScores(); renderNames();
  </script>
</body>
</html>
