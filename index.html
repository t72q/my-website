<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>برا السالفة.. بس ما أدري — لعبة حفلات</title>
  <style>
    :root{
      /* لوحة الألوان مستلهمة من النموذج الذي أرسلته */
      --bg:#7c93d8;           /* خلفية بنفسجي مزرق */
      --card:#f3f5ff;         /* بطاقات فاتحة */
      --ink:#ffffff;          /* نص عام */
      --dark:#1b1f3a;         /* نص داخل البطاقات */
      --muted:#b9c3ef;        /* نص باهت */
      --primary:#f7a61a;      /* برتقالي للأزرار الأساسية */
      --primary-ink:#ffffff;  /* نص الأزرار الأساسية */
      --accent:#a21c49;       /* خمري للتفاصيل */
      --shadow:0 8px 18px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial}
    .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
header .home{background:#c03b6a;border:none;color:#fff;width:44px;height:44px;border-radius:999px;display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer}
header .milk{font-weight:700;opacity:.9}

.container{flex:1;padding:14px}

h1,h2,h3{margin:0 0 12px}
h1{font-size:28px}
h2{font-size:22px}
p{color:var(--muted)}

.title{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.title .logo{width:38px;height:38px;display:grid;place-items:center;border-radius:12px;background:#c03b6a;font-weight:900;box-shadow:var(--shadow)}
.subtitle{opacity:.9;font-size:12px;color:#3b437a}

.card{background:var(--card);color:var(--dark);border:0;border-radius:18px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}

button{cursor:pointer;border:none}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:14px 24px;border-radius:16px;font-size:18px;font-weight:800;box-shadow:0 6px 0 rgba(0,0,0,.18);transition:transform .05s ease-in}
.btn:active{transform:translateY(2px)}
.btn-primary{background:var(--primary);color:var(--primary-ink)}
.btn-secondary{background:#e8ecff;color:#1b1f3a}
.btn-ghost{background:rgba(255,255,255,.14);color:#fff}

input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:2px solid transparent;outline:none;background:#fff;color:#111}
input:focus,select:focus,textarea:focus{border-color:#ffe29a}

.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px}
.list{display:flex;gap:8px;flex-wrap:wrap}

.pill{padding:12px 16px;border-radius:999px;background:#e8ecff;color:#1b1f3a;font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
.pill button{width:auto;padding:6px 10px;border-radius:10px;background:#ffb84a;color:#222}

.hidden{display:none}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}

.hr{height:1px;background:#dde2ff;margin:14px 0}
.footer{opacity:.9;font-size:12px;color:#3b437a}
.big{font-size:22px;color:#1b1f3a}
.word-flash{font-weight:900;font-size:34px;letter-spacing:1px;color:#c03b6a}

.badge{display:inline-block;padding:6px 10px;border-radius:12px;background:#ffe29a;color:#402d00;font-weight:800}
.score{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:#e8ecff;color:#1b1f3a}

.bottom{display:flex;gap:10px;justify-content:center;margin-top:8px}

.handoff-box{background:#fff;color:#111;border-radius:18px;padding:18px;box-shadow:var(--shadow)}

  </style>
</head>
<body>
  <div class="app">
    <header>
      <button class="home" id="homeBtn" title="الصفحة الرئيسية">🏠</button>
      <div class="milk">450 🥛</div>
    </header>
    <div class="container">
      <div class="title">
        <div class="logo">🕵️</div>
        <div>
          <h1 style="color:#ffcf5b;letter-spacing:1px;text-shadow:0 2px 0 rgba(0,0,0,.08)">برا السالفة.. بس ما أدري!</h1>
          <div class="subtitle">نفس فكرة لعبتنا، لكن بالروح البصرية اللي أعجبتك</div>
        </div>
      </div><!-- STEP 1: NAMES -->
  <div id="view-names" class="card">
    <h2>أسماء اللاعبين</h2>
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <label>أضف اسم لاعب</label>
        <input id="nameInput" placeholder="مثال: طارق">
      </div>
      <div class="col" style="max-width:200px">
        <button id="addNameBtn" class="btn btn-ghost">➕ إضافة</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="namesList" class="list"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button id="toCategory" class="btn btn-primary">التالي: اختيار التصنيف</button>
      <button id="clearNames" class="btn btn-secondary">مسح الأسماء</button>
    </div>
    <p class="footer">يجب إضافة 3 لاعبين على الأقل.</p>
  </div>

  <!-- STEP 2: CATEGORY & PAIRING -->
  <div id="view-category" class="card hidden">
    <h2>اختر التصنيف وطريقة الكلمات</h2>
    <div class="row">
      <div class="col">
        <label>التصنيف</label>
        <select id="categorySelect"></select>
      </div>
      <div class="col">
        <label>عدد الأسئلة قبل التصويت</label>
        <select id="questionCount">
          <option value="4">4</option>
          <option value="6" selected>6</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="col">
        <label>طريقة الاختيار</label>
        <select id="pairMode">
          <option value="random" selected>عشوائي</option>
          <option value="manual">اختيار يدوي</option>
        </select>
      </div>
    </div>
    <div id="manualPairs" class="row hidden">
      <div class="col">
        <label>الكلمة الأساسية (للأغلبية)</label>
        <input id="baseWord" placeholder="مثال: قهوة">
      </div>
      <div class="col">
        <label>كلمة المختلف (قريبة من الأساسية)</label>
        <input id="oddWord" placeholder="مثال: شاي">
      </div>
    </div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-secondary" id="backToNames">رجوع</button>
      <button id="startRound" class="btn btn-primary">ابدأ الجولة</button>
    </div>
  </div>

  <!-- STEP 3: PRIVATE REVEAL (SEQUENTIAL) -->
  <div id="view-reveal" class="card hidden">
    <h2>تمرير الجهاز لكل لاعب</h2>
    <div id="handoffBox" class="handoff-box">
      <div id="handoffText" class="big">—</div>
      <div class="hr"></div>
      <button id="revealBtn" class="btn btn-primary" style="width:100%">عرض الكلمة</button>
      <div id="wordShown" class="word-flash center hidden" style="margin-top:8px"></div>
      <div id="hint" class="footer center hidden">سيختفي خلال 3 ثوانٍ — لا تدع أحدًا يرى الشاشة</div>
    </div>
    <div class="bottom">
      <button class="btn btn-secondary" id="revealBack">رجوع</button>
      <button class="btn btn-ghost" id="revealNext">اللاعب التالي</button>
      <button class="btn btn-primary" id="toQuestions">ابدأ الأسئلة</button>
    </div>
  </div>

  <!-- QUESTIONS -->
  <div id="view-questions" class="card hidden">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2>جولة الأسئلة <span class="badge" id="qProgress">0/0</span></h2>
      <div class="badge" id="currentCategory">تصنيف</div>
    </div>
    <div class="hr"></div>
    <div class="card">
      <div class="big">سؤال:</div>
      <div id="questionText" class="word-flash" style="margin:6px 0 10px">…</div>
      <div class="subtitle">الدور الآن على: <span id="turnName" class="badge"></span></div>
    </div>
    <div class="bottom">
      <button id="nextQuestion" class="btn btn-primary">السؤال التالي</button>
      <button class="btn btn-secondary" id="goVote">انتقال للتصويت</button>
    </div>
    <p class="footer">تلميح: اسألوا أسئلة تكشف الفروقات الدقيقة 👀</p>
  </div>

  <!-- VOTE -->
  <div id="view-vote" class="card hidden">
    <h2>التصويت: مين برا السالفة؟</h2>
    <div id="voteArea" class="list" style="flex-direction:column"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-secondary" id="backToQuestions">رجوع للأسئلة</button>
      <button id="submitVotes" class="btn btn-primary">اعتماد التصويت</button>
    </div>
  </div>

  <!-- RESULT -->
  <div id="view-result" class="card hidden">
    <h2>النتيجة</h2>
    <div id="resultSummary" class="grid"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-ghost" id="newRoundSame">جولة جديدة (نفس اللاعبين)</button>
      <button id="newRoundReset" class="btn btn-primary">إعداد جديد</button>
    </div>
  </div>

  <!-- SCOREBOARD -->
  <div id="view-score" class="card hidden">
    <h2>النتائج المتراكمة</h2>
    <div id="scoreList" class="list" style="flex-direction:column"></div>
  </div>
</div>

  </div>  <script>
  // ===== Data Packs (تصنيفات + أزواج قريبة) =====
  const PACKS = {
    "حيوانات": [
      ["أسد","نمر"],["ذئب","كلب"],["قطة","أرنب"],["حصان","حمار"],["فيل","فرس النهر"],["جمل","لاما"],["صقر","نسر"],["دلفين","حوت"],["تمساح","سحلية"],["غزال","مها"]
    ],
    "أكلات ومشروبات": [
      ["بيتزا","برجر"],["شاورما","فاهيتا"],["قهوة","شاي"],["عصير برتقال","عصير مانجو"],["كابتشينو","لاتيه"],["رز","مكرونة"],["كعك","دونات"],["ماء غازي","عصير غازي"],["فول","حمص"],["عسل","دبس"]
    ],
    "أماكن ومدن": [
      ["باريس","لندن"],["مكة","المدينة"],["طوكيو","سول"],["الرياض","جدة"],["الصحراء","الواحة"],["شاطئ","مسبح"],["جامعة","مدرسة"],["مستشفى","عيادة"],["برج","قلعة"],["حديقة","محمية"]
    ],
    "أشياء يومية": [
      ["جوال","تابلت"],["مكيف","مروحة"],["قلم","ماركر"],["كرسي","أريكة"],["ريموت","يد تحكم"],["سماعات","سبيكر"],["حاسوب محمول","حاسوب مكتبي"],["مصباح","شمعة"],["ساعة يد","سوار ذكي"],["دراجة","سكوتر"]
    ]
  };

  const QUESTIONS = [
    "هل يُستخدم غالبًا في الصباح؟",
    "هل هو حلو عادةً؟",
    "هل يُؤكل/يُشرب ساخنًا؟",
    "هل لونه غامق؟",
    "هل تجده غالبًا في المنزل؟",
    "هل يُستخدم باليد مباشرة؟",
    "هل هو مرتبط بمكان محدد؟",
    "هل يُصدر صوتًا؟",
    "هل حجمه عادة صغير؟",
    "هل يُباع في متاجر متخصصة؟",
    "هل تحتاج كهرباء لتستعمله؟",
    "هل يمكن حمله؟",
    "هل يُعتبر صحيًا غالبًا؟",
    "هل يُستخدم في المناسبات؟",
    "هل له رائحة مميزة؟"
  ];

  // ===== State =====
  let state = {
    players: [],
    scores: {},
    category: null,
    pair: null, // {base, odd}
    oddIndex: null,
    turnOrder: [],
    asked: 0,
    maxQuestions: 6,
    usedQuestions: new Set(),
    votes: {},
    revealIdx: 0,
    revealed: {},
  };

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const el = (tag, cls, html) => {const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e;};
  const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];

  function saveScores(){ localStorage.setItem("bsb_scores", JSON.stringify(state.scores)); }
  function loadScores(){ const s=localStorage.getItem("bsb_scores"); if(s) state.scores = JSON.parse(s); }
  function renderScores(){ const box = $("#scoreList"); if(!box) return; box.innerHTML=''; const items = Object.entries(state.scores).sort((a,b)=>b[1]-a[1]); items.forEach(([name,pts])=>{ box.appendChild(el('div','score',`<strong>${name}</strong><span>${pts} نقطة</span>`)); }); $("#view-score").classList.toggle('hidden', items.length===0); }
  function setView(id){ ["#view-names","#view-category","#view-reveal","#view-questions","#view-vote","#view-result"].forEach(s=>$(s).classList.add('hidden')); $(id).classList.remove('hidden'); }

  // ===== Names Manager =====
  const namesListEl = $("#namesList");
  function renderNames(){
    namesListEl.innerHTML='';
    state.players.forEach((n,i)=>{
      const pill = el('div','pill');
      pill.appendChild(el('span',null,n));
      const del = el('button',null,'حذف');
      del.addEventListener('click',()=>{ state.players.splice(i,1); renderNames(); });
      pill.appendChild(del);
      namesListEl.appendChild(pill);
    });
  }
  $("#addNameBtn")?.addEventListener('click',()=>{
    const v = $("#nameInput").value.trim();
    if(!v) return;
    if(state.players.includes(v)) { alert('الاسم مكرر'); return; }
    state.players.push(v); $("#nameInput").value=''; renderNames();
  });
  $("#clearNames")?.addEventListener('click',()=>{ state.players = []; renderNames(); });
  $("#toCategory")?.addEventListener('click',()=>{
    if(state.players.length<3){ alert('أضف 3 لاعبين على الأقل'); return; }
    loadScores(); state.players.forEach(n=>{ if(!(n in state.scores)) state.scores[n]=0; }); renderScores();
    buildCategoryUI();
    setView('#view-category');
  });

  // ===== Category UI =====
  function buildCategoryUI(){
    const catSel = $("#categorySelect"); catSel.innerHTML='';
    Object.keys(PACKS).forEach(k=>{ const o=document.createElement('option'); o.value=k;o.textContent=k; catSel.appendChild(o);});
  }
  $("#pairMode")?.addEventListener('change', e=>{ $("#manualPairs").classList.toggle('hidden', e.target.value!=="manual"); });
  $("#backToNames")?.addEventListener('click',()=> setView('#view-names'));

  $("#startRound")?.addEventListener('click',()=>{
    state.maxQuestions = parseInt($("#questionCount").value,10);
    state.category = $("#categorySelect").value;

    let base, odd;
    if($("#pairMode").value === 'manual'){
      base = $("#baseWord").value.trim();
      odd = $("#oddWord").value.trim();
      if(!base || !odd){ alert('املأ الكلمتين من فضلك'); return; }
    } else {
      const p = choice(PACKS[state.category]);
      [base, odd] = Math.random()<.5 ? p : [p[1], p[0]];
    }

    state.pair = {base, odd};
    state.oddIndex = Math.floor(Math.random()*state.players.length);
    state.turnOrder = shuffle([...state.players]);
    state.asked = 0; state.usedQuestions = new Set(); state.votes = {}; state.revealIdx = 0; state.revealed={};

    buildRevealSequential();
    setView('#view-reveal');
  });

  // ===== Sequential Reveal =====
  function buildRevealSequential(){
    updateHandoffText();
    $("#wordShown").classList.add('hidden');
    $("#hint").classList.add('hidden');
  }
  function updateHandoffText(){
    const name = state.players[state.revealIdx];
    $("#handoffText").innerHTML = `📱 <strong>أعطوا الجهاز <span class="badge">${name}</span></strong>`;
    $("#revealBtn").disabled = false;
  }

  $("#revealBtn")?.addEventListener('click',()=>{
    const idx = state.revealIdx;
    const isOdd = idx === state.oddIndex;
    const word = isOdd ? state.pair.odd : state.pair.base;
    const wordEl = $("#wordShown");
    wordEl.textContent = word;
    wordEl.classList.remove('hidden');
    $("#hint").classList.remove('hidden');
    $("#revealBtn").disabled = true;
    state.revealed[state.players[idx]] = true;
    setTimeout(()=>{
      wordEl.classList.add('hidden');
      $("#hint").classList.add('hidden');
    },3000);
  });
  $("#revealNext")?.addEventListener('click',()=>{
    if(!state.revealed[state.players[state.revealIdx]]){ alert('اعرض الكلمة لهذا اللاعب أولاً'); return; }
    if(state.revealIdx < state.players.length-1){
      state.revealIdx++; updateHandoffText();
    } else {
      alert('تم عرض الكلمات للجميع. يمكنك بدء الأسئلة.');
    }
  });
  $("#revealBack")?.addEventListener('click',()=> setView('#view-category'));
  $("#toQuestions")?.addEventListener('click',()=>{
    const unseen = state.players.filter(n=>!state.revealed[n]);
    if(unseen.length){ if(!confirm('بعض اللاعبين لم يشاهدوا كلمتهم. البدء على أي حال؟')) return; }
    $("#currentCategory").textContent = state.category;
    updateQuestionUI();
    setView('#view-questions');
  });

  // ===== Questions & Voting =====
  function updateQuestionUI(){
    $("#qProgress").textContent = `${state.asked}/${state.maxQuestions}`;
    const q = nextQuestion();
    $("#questionText").textContent = q;
    const turn = state.turnOrder[state.asked % state.players.length];
    $("#turnName").textContent = turn;
  }
  function nextQuestion(){
    let q; const available = QUESTIONS.filter(x=>!state.usedQuestions.has(x)); if(!available.length){ state.usedQuestions.clear(); }
    do { q = choice(QUESTIONS); } while(state.usedQuestions.has(q));
    state.usedQuestions.add(q); return q;
  }
  $("#nextQuestion")?.addEventListener('click',()=>{
    if(state.asked+1 >= state.maxQuestions){ alert('بلغت حد الأسئلة. انتقل للتصويت.'); return; }
    state.asked++; if(Math.random()<0.4) state.turnOrder = shuffle(state.turnOrder); updateQuestionUI();
  });
  $("#goVote")?.addEventListener('click',()=>{ buildVoteUI(); setView('#view-vote'); });
  $("#backToQuestions")?.addEventListener('click',()=> setView('#view-questions'));

  function buildVoteUI(){
    const area = $("#voteArea"); area.innerHTML=''; state.votes = {};
    state.players.forEach(voter=>{
      const row = el('div','list');
      row.style.alignItems='center';
      const lab = el('div','badge',voter);
      const sel = document.createElement('select');
      sel.style.maxWidth='240px';
      sel.innerHTML = `<option value="">اختر المشكوك</option>` + state.players.map((p,i)=>`<option value="${i}" ${p===voter?'disabled':''}>${p}</option>`).join('');
      sel.addEventListener('change', ()=>{ state.votes[voter] = parseInt(sel.value,10); });
      row.appendChild(lab); row.appendChild(sel); area.appendChild(row);
    });
  }

  $("#submitVotes")?.addEventListener('click',()=>{
    const missing = state.players.filter(p=>!(p in state.votes)); if(missing.length){ alert('لسه ما صوّت الجميع.'); return; }
    const tally = new Array(state.players.length).fill(0);
    Object.values(state.votes).forEach(idx=>{ if(Number.isInteger(idx)) tally[idx]++; });
    const most = Math.max(...tally); const suspects = tally.map((c,i)=>[c,i]).filter(([c])=>c===most).map(([,i])=>i);
    const caught = suspects.includes(state.oddIndex);
    const oddName = state.players[state.oddIndex];
    if(caught){ state.scores[oddName] += 0; } else { state.scores[oddName] += 3; }
    for(const [voter, idx] of Object.entries(state.votes)){
      if(idx === state.oddIndex && caught){ state.scores[voter] += 1; }
      else if(idx !== state.oddIndex){ state.scores[voter] -= 1; }
    }
    saveScores(); renderScores(); showResult(tally, suspects, caught); setView('#view-result');
  });

  function showResult(tally, suspects, caught){
    const box = $("#resultSummary"); box.innerHTML=''; const oddName = state.players[state.oddIndex];
    const a = el('div','card', `
      <div class="big">المختلف كان: <strong>${oddName}</strong></div>
      <div class="subtitle">كلمة الأغلبية: <span class="badge">${state.pair.base}</span></div>
      <div class="subtitle">كلمة المختلف: <span class="badge">${state.pair.odd}</span></div>
      <div class="hr"></div>
      <div>${caught ? '👏 تم كشف المختلف — (+1) لمن صوّت صحيح' : '😎 ما أحد كشف المختلف — (+3) للمختلف'}</div>
    `);
    const b = el('div','card'); b.innerHTML = `<h3 style="margin-bottom:10px;color:#1b1f3a">تفاصيل التصويت</h3>`; const ul = el('div','list'); ul.style.flexDirection='column';
    state.players.forEach((p,i)=>{
      const voters = Object.entries(state.votes).filter(([,idx])=>idx===i).map(([name])=>name);
      ul.appendChild(el('div',null,`<span class="badge">${p}</span> — ${tally[i]} صوت ${voters.length?`<span class=\"subtitle\">(${voters.join('، ')})</span>`:''}`));
    }); b.appendChild(ul);
    const c = el('div','card'); c.innerHTML = `<h3 style="margin-bottom:10px;color:#1b1f3a">الترتيب الحالي</h3>`; const rank = el('div','list'); rank.style.flexDirection='column';
    Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,s])=>{ rank.appendChild(el('div','score',`<strong>${n}</strong><span>${s} نقطة</span>`)); }); c.appendChild(rank);
    box.appendChild(a); box.appendChild(b); box.appendChild(c);
  }

  // New round buttons + header
  document.getElementById('homeBtn')?.addEventListener('click',()=> setView('#view-names'));
  $("#newRoundSame")?.addEventListener('click',()=>{ buildCategoryUI(); setView('#view-category'); });
  $("#newRoundReset")?.addEventListener('click',()=>{ state.players=[]; renderNames(); setView('#view-names'); });

  // init
  loadScores(); renderScores(); renderNames();
  </script></body>
</html>
