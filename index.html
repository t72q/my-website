<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©.. Ø¨Ø³ Ù…Ø§ Ø£Ø¯Ø±ÙŠ â€” Ù„Ø¹Ø¨Ø© Ø­ÙÙ„Ø§Øª</title>
  <style>
    :root{
      /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ø³ØªÙ„Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ */
      --bg:#7c93d8;           /* Ø®Ù„ÙÙŠØ© Ø¨Ù†ÙØ³Ø¬ÙŠ Ù…Ø²Ø±Ù‚ */
      --card:#f3f5ff;         /* Ø¨Ø·Ø§Ù‚Ø§Øª ÙØ§ØªØ­Ø© */
      --ink:#ffffff;          /* Ù†Øµ Ø¹Ø§Ù… */
      --dark:#1b1f3a;         /* Ù†Øµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
      --muted:#b9c3ef;        /* Ù†Øµ Ø¨Ø§Ù‡Øª */
      --primary:#f7a61a;      /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
      --primary-ink:#ffffff;  /* Ù†Øµ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
      --accent:#a21c49;       /* Ø®Ù…Ø±ÙŠ Ù„Ù„ØªÙØ§ØµÙŠÙ„ */
      --shadow:0 8px 18px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial}
    .app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
header .home{background:#c03b6a;border:none;color:#fff;width:44px;height:44px;border-radius:999px;display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer}
header .milk{font-weight:700;opacity:.9}

.container{flex:1;padding:14px}

h1,h2,h3{margin:0 0 12px}
h1{font-size:28px}
h2{font-size:22px}
p{color:var(--muted)}

.title{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.title .logo{width:38px;height:38px;display:grid;place-items:center;border-radius:12px;background:#c03b6a;font-weight:900;box-shadow:var(--shadow)}
.subtitle{opacity:.9;font-size:12px;color:#3b437a}

.card{background:var(--card);color:var(--dark);border:0;border-radius:18px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}

button{cursor:pointer;border:none}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:14px 24px;border-radius:16px;font-size:18px;font-weight:800;box-shadow:0 6px 0 rgba(0,0,0,.18);transition:transform .05s ease-in}
.btn:active{transform:translateY(2px)}
.btn-primary{background:var(--primary);color:var(--primary-ink)}
.btn-secondary{background:#e8ecff;color:#1b1f3a}
.btn-ghost{background:rgba(255,255,255,.14);color:#fff}

input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:2px solid transparent;outline:none;background:#fff;color:#111}
input:focus,select:focus,textarea:focus{border-color:#ffe29a}

.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 240px}
.list{display:flex;gap:8px;flex-wrap:wrap}

.pill{padding:12px 16px;border-radius:999px;background:#e8ecff;color:#1b1f3a;font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow)}
.pill button{width:auto;padding:6px 10px;border-radius:10px;background:#ffb84a;color:#222}

.hidden{display:none}
.grid{display:grid;gap:10px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}

.hr{height:1px;background:#dde2ff;margin:14px 0}
.footer{opacity:.9;font-size:12px;color:#3b437a}
.big{font-size:22px;color:#1b1f3a}
.word-flash{font-weight:900;font-size:34px;letter-spacing:1px;color:#c03b6a}

.badge{display:inline-block;padding:6px 10px;border-radius:12px;background:#ffe29a;color:#402d00;font-weight:800}
.score{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:#e8ecff;color:#1b1f3a}

.bottom{display:flex;gap:10px;justify-content:center;margin-top:8px}

.handoff-box{background:#fff;color:#111;border-radius:18px;padding:18px;box-shadow:var(--shadow)}

  </style>
</head>
<body>
  <div class="app">
    <header>
      <button class="home" id="homeBtn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">ğŸ </button>
      <div class="milk">450 ğŸ¥›</div>
    </header>
    <div class="container">
      <div class="title">
        <div class="logo">ğŸ•µï¸</div>
        <div>
          <h1 style="color:#ffcf5b;letter-spacing:1px;text-shadow:0 2px 0 rgba(0,0,0,.08)">Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©.. Ø¨Ø³ Ù…Ø§ Ø£Ø¯Ø±ÙŠ!</h1>
          <div class="subtitle">Ù†ÙØ³ ÙÙƒØ±Ø© Ù„Ø¹Ø¨ØªÙ†Ø§ØŒ Ù„ÙƒÙ† Ø¨Ø§Ù„Ø±ÙˆØ­ Ø§Ù„Ø¨ØµØ±ÙŠØ© Ø§Ù„Ù„ÙŠ Ø£Ø¹Ø¬Ø¨ØªÙƒ</div>
        </div>
      </div><!-- STEP 1: NAMES -->
  <div id="view-names" class="card">
    <h2>Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <label>Ø£Ø¶Ù Ø§Ø³Ù… Ù„Ø§Ø¹Ø¨</label>
        <input id="nameInput" placeholder="Ù…Ø«Ø§Ù„: Ø·Ø§Ø±Ù‚">
      </div>
      <div class="col" style="max-width:200px">
        <button id="addNameBtn" class="btn btn-ghost">â• Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>
    <div class="hr"></div>
    <div id="namesList" class="list"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button id="toCategory" class="btn btn-primary">Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ</button>
      <button id="clearNames" class="btn btn-secondary">Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
    </div>
    <p class="footer">ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</p>
  </div>

  <!-- STEP 2: CATEGORY & PAIRING -->
  <div id="view-category" class="card hidden">
    <h2>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª</h2>
    <div class="row">
      <div class="col">
        <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
        <select id="categorySelect"></select>
      </div>
      <div class="col">
        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙˆÙŠØª</label>
        <select id="questionCount">
          <option value="4">4</option>
          <option value="6" selected>6</option>
          <option value="8">8</option>
        </select>
      </div>
      <div class="col">
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</label>
        <select id="pairMode">
          <option value="random" selected>Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
          <option value="manual">Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ</option>
        </select>
      </div>
    </div>
    <div id="manualPairs" class="row hidden">
      <div class="col">
        <label>Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ù„Ø£ØºÙ„Ø¨ÙŠØ©)</label>
        <input id="baseWord" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ù‡ÙˆØ©">
      </div>
      <div class="col">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„Ù (Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)</label>
        <input id="oddWord" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§ÙŠ">
      </div>
    </div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-secondary" id="backToNames">Ø±Ø¬ÙˆØ¹</button>
      <button id="startRound" class="btn btn-primary">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
    </div>
  </div>

  <!-- STEP 3: PRIVATE REVEAL (SEQUENTIAL) -->
  <div id="view-reveal" class="card hidden">
    <h2>ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨</h2>
    <div id="handoffBox" class="handoff-box">
      <div id="handoffText" class="big">â€”</div>
      <div class="hr"></div>
      <button id="revealBtn" class="btn btn-primary" style="width:100%">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø©</button>
      <div id="wordShown" class="word-flash center hidden" style="margin-top:8px"></div>
      <div id="hint" class="footer center hidden">Ø³ÙŠØ®ØªÙÙŠ Ø®Ù„Ø§Ù„ 3 Ø«ÙˆØ§Ù†Ù â€” Ù„Ø§ ØªØ¯Ø¹ Ø£Ø­Ø¯Ù‹Ø§ ÙŠØ±Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©</div>
    </div>
    <div class="bottom">
      <button class="btn btn-secondary" id="revealBack">Ø±Ø¬ÙˆØ¹</button>
      <button class="btn btn-ghost" id="revealNext">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ</button>
      <button class="btn btn-primary" id="toQuestions">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
    </div>
  </div>

  <!-- QUESTIONS -->
  <div id="view-questions" class="card hidden">
    <div class="row" style="align-items:center;justify-content:space-between">
      <h2>Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© <span class="badge" id="qProgress">0/0</span></h2>
      <div class="badge" id="currentCategory">ØªØµÙ†ÙŠÙ</div>
    </div>
    <div class="hr"></div>
    <div class="card">
      <div class="big">Ø³Ø¤Ø§Ù„:</div>
      <div id="questionText" class="word-flash" style="margin:6px 0 10px">â€¦</div>
      <div class="subtitle">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰: <span id="turnName" class="badge"></span></div>
    </div>
    <div class="bottom">
      <button id="nextQuestion" class="btn btn-primary">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
      <button class="btn btn-secondary" id="goVote">Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØµÙˆÙŠØª</button>
    </div>
    <p class="footer">ØªÙ„Ù…ÙŠØ­: Ø§Ø³Ø£Ù„ÙˆØ§ Ø£Ø³Ø¦Ù„Ø© ØªÙƒØ´Ù Ø§Ù„ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ğŸ‘€</p>
  </div>

  <!-- VOTE -->
  <div id="view-vote" class="card hidden">
    <h2>Ø§Ù„ØªØµÙˆÙŠØª: Ù…ÙŠÙ† Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ</h2>
    <div id="voteArea" class="list" style="flex-direction:column"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-secondary" id="backToQuestions">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ø³Ø¦Ù„Ø©</button>
      <button id="submitVotes" class="btn btn-primary">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªØµÙˆÙŠØª</button>
    </div>
  </div>

  <!-- RESULT -->
  <div id="view-result" class="card hidden">
    <h2>Ø§Ù„Ù†ØªÙŠØ¬Ø©</h2>
    <div id="resultSummary" class="grid"></div>
    <div class="hr"></div>
    <div class="bottom">
      <button class="btn btn-ghost" id="newRoundSame">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)</button>
      <button id="newRoundReset" class="btn btn-primary">Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <!-- SCOREBOARD -->
  <div id="view-score" class="card hidden">
    <h2>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©</h2>
    <div id="scoreList" class="list" style="flex-direction:column"></div>
  </div>
</div>

  </div>  <script>
  // ===== Data Packs (ØªØµÙ†ÙŠÙØ§Øª + Ø£Ø²ÙˆØ§Ø¬ Ù‚Ø±ÙŠØ¨Ø©) =====
  const PACKS = {
    "Ø­ÙŠÙˆØ§Ù†Ø§Øª": [
      ["Ø£Ø³Ø¯","Ù†Ù…Ø±"],["Ø°Ø¦Ø¨","ÙƒÙ„Ø¨"],["Ù‚Ø·Ø©","Ø£Ø±Ù†Ø¨"],["Ø­ØµØ§Ù†","Ø­Ù…Ø§Ø±"],["ÙÙŠÙ„","ÙØ±Ø³ Ø§Ù„Ù†Ù‡Ø±"],["Ø¬Ù…Ù„","Ù„Ø§Ù…Ø§"],["ØµÙ‚Ø±","Ù†Ø³Ø±"],["Ø¯Ù„ÙÙŠÙ†","Ø­ÙˆØª"],["ØªÙ…Ø³Ø§Ø­","Ø³Ø­Ù„ÙŠØ©"],["ØºØ²Ø§Ù„","Ù…Ù‡Ø§"]
    ],
    "Ø£ÙƒÙ„Ø§Øª ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª": [
      ["Ø¨ÙŠØªØ²Ø§","Ø¨Ø±Ø¬Ø±"],["Ø´Ø§ÙˆØ±Ù…Ø§","ÙØ§Ù‡ÙŠØªØ§"],["Ù‚Ù‡ÙˆØ©","Ø´Ø§ÙŠ"],["Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„","Ø¹ØµÙŠØ± Ù…Ø§Ù†Ø¬Ùˆ"],["ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ","Ù„Ø§ØªÙŠÙ‡"],["Ø±Ø²","Ù…ÙƒØ±ÙˆÙ†Ø©"],["ÙƒØ¹Ùƒ","Ø¯ÙˆÙ†Ø§Øª"],["Ù…Ø§Ø¡ ØºØ§Ø²ÙŠ","Ø¹ØµÙŠØ± ØºØ§Ø²ÙŠ"],["ÙÙˆÙ„","Ø­Ù…Øµ"],["Ø¹Ø³Ù„","Ø¯Ø¨Ø³"]
    ],
    "Ø£Ù…Ø§ÙƒÙ† ÙˆÙ…Ø¯Ù†": [
      ["Ø¨Ø§Ø±ÙŠØ³","Ù„Ù†Ø¯Ù†"],["Ù…ÙƒØ©","Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"],["Ø·ÙˆÙƒÙŠÙˆ","Ø³ÙˆÙ„"],["Ø§Ù„Ø±ÙŠØ§Ø¶","Ø¬Ø¯Ø©"],["Ø§Ù„ØµØ­Ø±Ø§Ø¡","Ø§Ù„ÙˆØ§Ø­Ø©"],["Ø´Ø§Ø·Ø¦","Ù…Ø³Ø¨Ø­"],["Ø¬Ø§Ù…Ø¹Ø©","Ù…Ø¯Ø±Ø³Ø©"],["Ù…Ø³ØªØ´ÙÙ‰","Ø¹ÙŠØ§Ø¯Ø©"],["Ø¨Ø±Ø¬","Ù‚Ù„Ø¹Ø©"],["Ø­Ø¯ÙŠÙ‚Ø©","Ù…Ø­Ù…ÙŠØ©"]
    ],
    "Ø£Ø´ÙŠØ§Ø¡ ÙŠÙˆÙ…ÙŠØ©": [
      ["Ø¬ÙˆØ§Ù„","ØªØ§Ø¨Ù„Øª"],["Ù…ÙƒÙŠÙ","Ù…Ø±ÙˆØ­Ø©"],["Ù‚Ù„Ù…","Ù…Ø§Ø±ÙƒØ±"],["ÙƒØ±Ø³ÙŠ","Ø£Ø±ÙŠÙƒØ©"],["Ø±ÙŠÙ…ÙˆØª","ÙŠØ¯ ØªØ­ÙƒÙ…"],["Ø³Ù…Ø§Ø¹Ø§Øª","Ø³Ø¨ÙŠÙƒØ±"],["Ø­Ø§Ø³ÙˆØ¨ Ù…Ø­Ù…ÙˆÙ„","Ø­Ø§Ø³ÙˆØ¨ Ù…ÙƒØªØ¨ÙŠ"],["Ù…ØµØ¨Ø§Ø­","Ø´Ù…Ø¹Ø©"],["Ø³Ø§Ø¹Ø© ÙŠØ¯","Ø³ÙˆØ§Ø± Ø°ÙƒÙŠ"],["Ø¯Ø±Ø§Ø¬Ø©","Ø³ÙƒÙˆØªØ±"]
    ]
  };

  const QUESTIONS = [
    "Ù‡Ù„ ÙŠÙØ³ØªØ®Ø¯Ù… ØºØ§Ù„Ø¨Ù‹Ø§ ÙÙŠ Ø§Ù„ØµØ¨Ø§Ø­ØŸ",
    "Ù‡Ù„ Ù‡Ùˆ Ø­Ù„Ùˆ Ø¹Ø§Ø¯Ø©Ù‹ØŸ",
    "Ù‡Ù„ ÙŠÙØ¤ÙƒÙ„/ÙŠÙØ´Ø±Ø¨ Ø³Ø§Ø®Ù†Ù‹Ø§ØŸ",
    "Ù‡Ù„ Ù„ÙˆÙ†Ù‡ ØºØ§Ù…Ù‚ØŸ",
    "Ù‡Ù„ ØªØ¬Ø¯Ù‡ ØºØ§Ù„Ø¨Ù‹Ø§ ÙÙŠ Ø§Ù„Ù…Ù†Ø²Ù„ØŸ",
    "Ù‡Ù„ ÙŠÙØ³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙŠØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©ØŸ",
    "Ù‡Ù„ Ù‡Ùˆ Ù…Ø±ØªØ¨Ø· Ø¨Ù…ÙƒØ§Ù† Ù…Ø­Ø¯Ø¯ØŸ",
    "Ù‡Ù„ ÙŠÙØµØ¯Ø± ØµÙˆØªÙ‹Ø§ØŸ",
    "Ù‡Ù„ Ø­Ø¬Ù…Ù‡ Ø¹Ø§Ø¯Ø© ØµØºÙŠØ±ØŸ",
    "Ù‡Ù„ ÙŠÙØ¨Ø§Ø¹ ÙÙŠ Ù…ØªØ§Ø¬Ø± Ù…ØªØ®ØµØµØ©ØŸ",
    "Ù‡Ù„ ØªØ­ØªØ§Ø¬ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù„ØªØ³ØªØ¹Ù…Ù„Ù‡ØŸ",
    "Ù‡Ù„ ÙŠÙ…ÙƒÙ† Ø­Ù…Ù„Ù‡ØŸ",
    "Ù‡Ù„ ÙŠÙØ¹ØªØ¨Ø± ØµØ­ÙŠÙ‹Ø§ ØºØ§Ù„Ø¨Ù‹Ø§ØŸ",
    "Ù‡Ù„ ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§ØªØŸ",
    "Ù‡Ù„ Ù„Ù‡ Ø±Ø§Ø¦Ø­Ø© Ù…Ù…ÙŠØ²Ø©ØŸ"
  ];

  // ===== State =====
  let state = {
    players: [],
    scores: {},
    category: null,
    pair: null, // {base, odd}
    oddIndex: null,
    turnOrder: [],
    asked: 0,
    maxQuestions: 6,
    usedQuestions: new Set(),
    votes: {},
    revealIdx: 0,
    revealed: {},
  };

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const el = (tag, cls, html) => {const e=document.createElement(tag); if(cls) e.className=cls; if(html!==undefined) e.innerHTML=html; return e;};
  const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];

  function saveScores(){ localStorage.setItem("bsb_scores", JSON.stringify(state.scores)); }
  function loadScores(){ const s=localStorage.getItem("bsb_scores"); if(s) state.scores = JSON.parse(s); }
  function renderScores(){ const box = $("#scoreList"); if(!box) return; box.innerHTML=''; const items = Object.entries(state.scores).sort((a,b)=>b[1]-a[1]); items.forEach(([name,pts])=>{ box.appendChild(el('div','score',`<strong>${name}</strong><span>${pts} Ù†Ù‚Ø·Ø©</span>`)); }); $("#view-score").classList.toggle('hidden', items.length===0); }
  function setView(id){ ["#view-names","#view-category","#view-reveal","#view-questions","#view-vote","#view-result"].forEach(s=>$(s).classList.add('hidden')); $(id).classList.remove('hidden'); }

  // ===== Names Manager =====
  const namesListEl = $("#namesList");
  function renderNames(){
    namesListEl.innerHTML='';
    state.players.forEach((n,i)=>{
      const pill = el('div','pill');
      pill.appendChild(el('span',null,n));
      const del = el('button',null,'Ø­Ø°Ù');
      del.addEventListener('click',()=>{ state.players.splice(i,1); renderNames(); });
      pill.appendChild(del);
      namesListEl.appendChild(pill);
    });
  }
  $("#addNameBtn")?.addEventListener('click',()=>{
    const v = $("#nameInput").value.trim();
    if(!v) return;
    if(state.players.includes(v)) { alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙƒØ±Ø±'); return; }
    state.players.push(v); $("#nameInput").value=''; renderNames();
  });
  $("#clearNames")?.addEventListener('click',()=>{ state.players = []; renderNames(); });
  $("#toCategory")?.addEventListener('click',()=>{
    if(state.players.length<3){ alert('Ø£Ø¶Ù 3 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
    loadScores(); state.players.forEach(n=>{ if(!(n in state.scores)) state.scores[n]=0; }); renderScores();
    buildCategoryUI();
    setView('#view-category');
  });

  // ===== Category UI =====
  function buildCategoryUI(){
    const catSel = $("#categorySelect"); catSel.innerHTML='';
    Object.keys(PACKS).forEach(k=>{ const o=document.createElement('option'); o.value=k;o.textContent=k; catSel.appendChild(o);});
  }
  $("#pairMode")?.addEventListener('change', e=>{ $("#manualPairs").classList.toggle('hidden', e.target.value!=="manual"); });
  $("#backToNames")?.addEventListener('click',()=> setView('#view-names'));

  $("#startRound")?.addEventListener('click',()=>{
    state.maxQuestions = parseInt($("#questionCount").value,10);
    state.category = $("#categorySelect").value;

    let base, odd;
    if($("#pairMode").value === 'manual'){
      base = $("#baseWord").value.trim();
      odd = $("#oddWord").value.trim();
      if(!base || !odd){ alert('Ø§Ù…Ù„Ø£ Ø§Ù„ÙƒÙ„Ù…ØªÙŠÙ† Ù…Ù† ÙØ¶Ù„Ùƒ'); return; }
    } else {
      const p = choice(PACKS[state.category]);
      [base, odd] = Math.random()<.5 ? p : [p[1], p[0]];
    }

    state.pair = {base, odd};
    state.oddIndex = Math.floor(Math.random()*state.players.length);
    state.turnOrder = shuffle([...state.players]);
    state.asked = 0; state.usedQuestions = new Set(); state.votes = {}; state.revealIdx = 0; state.revealed={};

    buildRevealSequential();
    setView('#view-reveal');
  });

  // ===== Sequential Reveal =====
  function buildRevealSequential(){
    updateHandoffText();
    $("#wordShown").classList.add('hidden');
    $("#hint").classList.add('hidden');
  }
  function updateHandoffText(){
    const name = state.players[state.revealIdx];
    $("#handoffText").innerHTML = `ğŸ“± <strong>Ø£Ø¹Ø·ÙˆØ§ Ø§Ù„Ø¬Ù‡Ø§Ø² <span class="badge">${name}</span></strong>`;
    $("#revealBtn").disabled = false;
  }

  $("#revealBtn")?.addEventListener('click',()=>{
    const idx = state.revealIdx;
    const isOdd = idx === state.oddIndex;
    const word = isOdd ? state.pair.odd : state.pair.base;
    const wordEl = $("#wordShown");
    wordEl.textContent = word;
    wordEl.classList.remove('hidden');
    $("#hint").classList.remove('hidden');
    $("#revealBtn").disabled = true;
    state.revealed[state.players[idx]] = true;
    setTimeout(()=>{
      wordEl.classList.add('hidden');
      $("#hint").classList.add('hidden');
    },3000);
  });
  $("#revealNext")?.addEventListener('click',()=>{
    if(!state.revealed[state.players[state.revealIdx]]){ alert('Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    if(state.revealIdx < state.players.length-1){
      state.revealIdx++; updateHandoffText();
    } else {
      alert('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¬Ù…ÙŠØ¹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.');
    }
  });
  $("#revealBack")?.addEventListener('click',()=> setView('#view-category'));
  $("#toQuestions")?.addEventListener('click',()=>{
    const unseen = state.players.filter(n=>!state.revealed[n]);
    if(unseen.length){ if(!confirm('Ø¨Ø¹Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù… ÙŠØ´Ø§Ù‡Ø¯ÙˆØ§ ÙƒÙ„Ù…ØªÙ‡Ù…. Ø§Ù„Ø¨Ø¯Ø¡ Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ')) return; }
    $("#currentCategory").textContent = state.category;
    updateQuestionUI();
    setView('#view-questions');
  });

  // ===== Questions & Voting =====
  function updateQuestionUI(){
    $("#qProgress").textContent = `${state.asked}/${state.maxQuestions}`;
    const q = nextQuestion();
    $("#questionText").textContent = q;
    const turn = state.turnOrder[state.asked % state.players.length];
    $("#turnName").textContent = turn;
  }
  function nextQuestion(){
    let q; const available = QUESTIONS.filter(x=>!state.usedQuestions.has(x)); if(!available.length){ state.usedQuestions.clear(); }
    do { q = choice(QUESTIONS); } while(state.usedQuestions.has(q));
    state.usedQuestions.add(q); return q;
  }
  $("#nextQuestion")?.addEventListener('click',()=>{
    if(state.asked+1 >= state.maxQuestions){ alert('Ø¨Ù„ØºØª Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ØªØµÙˆÙŠØª.'); return; }
    state.asked++; if(Math.random()<0.4) state.turnOrder = shuffle(state.turnOrder); updateQuestionUI();
  });
  $("#goVote")?.addEventListener('click',()=>{ buildVoteUI(); setView('#view-vote'); });
  $("#backToQuestions")?.addEventListener('click',()=> setView('#view-questions'));

  function buildVoteUI(){
    const area = $("#voteArea"); area.innerHTML=''; state.votes = {};
    state.players.forEach(voter=>{
      const row = el('div','list');
      row.style.alignItems='center';
      const lab = el('div','badge',voter);
      const sel = document.createElement('select');
      sel.style.maxWidth='240px';
      sel.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´ÙƒÙˆÙƒ</option>` + state.players.map((p,i)=>`<option value="${i}" ${p===voter?'disabled':''}>${p}</option>`).join('');
      sel.addEventListener('change', ()=>{ state.votes[voter] = parseInt(sel.value,10); });
      row.appendChild(lab); row.appendChild(sel); area.appendChild(row);
    });
  }

  $("#submitVotes")?.addEventListener('click',()=>{
    const missing = state.players.filter(p=>!(p in state.votes)); if(missing.length){ alert('Ù„Ø³Ù‡ Ù…Ø§ ØµÙˆÙ‘Øª Ø§Ù„Ø¬Ù…ÙŠØ¹.'); return; }
    const tally = new Array(state.players.length).fill(0);
    Object.values(state.votes).forEach(idx=>{ if(Number.isInteger(idx)) tally[idx]++; });
    const most = Math.max(...tally); const suspects = tally.map((c,i)=>[c,i]).filter(([c])=>c===most).map(([,i])=>i);
    const caught = suspects.includes(state.oddIndex);
    const oddName = state.players[state.oddIndex];
    if(caught){ state.scores[oddName] += 0; } else { state.scores[oddName] += 3; }
    for(const [voter, idx] of Object.entries(state.votes)){
      if(idx === state.oddIndex && caught){ state.scores[voter] += 1; }
      else if(idx !== state.oddIndex){ state.scores[voter] -= 1; }
    }
    saveScores(); renderScores(); showResult(tally, suspects, caught); setView('#view-result');
  });

  function showResult(tally, suspects, caught){
    const box = $("#resultSummary"); box.innerHTML=''; const oddName = state.players[state.oddIndex];
    const a = el('div','card', `
      <div class="big">Ø§Ù„Ù…Ø®ØªÙ„Ù ÙƒØ§Ù†: <strong>${oddName}</strong></div>
      <div class="subtitle">ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ØºÙ„Ø¨ÙŠØ©: <span class="badge">${state.pair.base}</span></div>
      <div class="subtitle">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„Ù: <span class="badge">${state.pair.odd}</span></div>
      <div class="hr"></div>
      <div>${caught ? 'ğŸ‘ ØªÙ… ÙƒØ´Ù Ø§Ù„Ù…Ø®ØªÙ„Ù â€” (+1) Ù„Ù…Ù† ØµÙˆÙ‘Øª ØµØ­ÙŠØ­' : 'ğŸ˜ Ù…Ø§ Ø£Ø­Ø¯ ÙƒØ´Ù Ø§Ù„Ù…Ø®ØªÙ„Ù â€” (+3) Ù„Ù„Ù…Ø®ØªÙ„Ù'}</div>
    `);
    const b = el('div','card'); b.innerHTML = `<h3 style="margin-bottom:10px;color:#1b1f3a">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµÙˆÙŠØª</h3>`; const ul = el('div','list'); ul.style.flexDirection='column';
    state.players.forEach((p,i)=>{
      const voters = Object.entries(state.votes).filter(([,idx])=>idx===i).map(([name])=>name);
      ul.appendChild(el('div',null,`<span class="badge">${p}</span> â€” ${tally[i]} ØµÙˆØª ${voters.length?`<span class=\"subtitle\">(${voters.join('ØŒ ')})</span>`:''}`));
    }); b.appendChild(ul);
    const c = el('div','card'); c.innerHTML = `<h3 style="margin-bottom:10px;color:#1b1f3a">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>`; const rank = el('div','list'); rank.style.flexDirection='column';
    Object.entries(state.scores).sort((a,b)=>b[1]-a[1]).forEach(([n,s])=>{ rank.appendChild(el('div','score',`<strong>${n}</strong><span>${s} Ù†Ù‚Ø·Ø©</span>`)); }); c.appendChild(rank);
    box.appendChild(a); box.appendChild(b); box.appendChild(c);
  }

  // New round buttons + header
  document.getElementById('homeBtn')?.addEventListener('click',()=> setView('#view-names'));
  $("#newRoundSame")?.addEventListener('click',()=>{ buildCategoryUI(); setView('#view-category'); });
  $("#newRoundReset")?.addEventListener('click',()=>{ state.players=[]; renderNames(); setView('#view-names'); });

  // init
  loadScores(); renderScores(); renderNames();
  </script></body>
</html>
